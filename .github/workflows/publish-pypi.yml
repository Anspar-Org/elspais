name: Publish to PyPI & Update Homebrew

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      skip_pypi:
        description: 'Skip PyPI upload (just update Homebrew)'
        type: boolean
        default: false
  workflow_call:
    inputs:
      version:
        description: 'Version to publish (without v prefix)'
        type: string
        required: true
      skip_pypi:
        description: 'Skip PyPI upload (just update Homebrew)'
        type: boolean
        default: false

jobs:
  publish:
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_pypi }}
    permissions:
      id-token: write  # for trusted publishing

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: twine upload dist/*

  update-homebrew:
    runs-on: ubuntu-latest
    needs: [publish]
    if: always() && (needs.publish.result == 'success' || inputs.skip_pypi)

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # workflow_call: version passed explicitly
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            # release: strip 'v' prefix from tag
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            # workflow_dispatch: read from pyproject.toml
            VERSION=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Find triggering PR author
        id: author
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          AUTHOR=$(gh api "repos/${{ github.repository }}/commits/${{ github.sha }}/pulls" \
            --jq '.[0].user.login // empty' 2>/dev/null || echo "")
          echo "login=${AUTHOR:-${{ github.actor }}}" >> "$GITHUB_OUTPUT"

      - name: Trigger Homebrew tap update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: Anspar-Org/homebrew-anspar
          event-type: update-formula
          client-payload: '{"package": "elspais", "version": "${{ steps.version.outputs.version }}", "author": "${{ steps.author.outputs.login }}"}'

  notify-success:
    name: Notify on Success
    runs-on: ubuntu-latest
    needs: [publish, update-homebrew]
    if: >-
      always()
      && (needs.publish.result == 'success' || needs.publish.result == 'skipped')
      && needs.update-homebrew.result == 'success'
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Find triggering PR
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_JSON=$(gh api "repos/${{ github.repository }}/commits/${{ github.sha }}/pulls" \
            --jq '.[0] // empty' 2>/dev/null || echo "")

          if [ -n "$PR_JSON" ]; then
            echo "number=$(echo "$PR_JSON" | jq -r '.number')" >> "$GITHUB_OUTPUT"
            echo "title=$(echo "$PR_JSON" | jq -r '.title')" >> "$GITHUB_OUTPUT"
            echo "url=$(echo "$PR_JSON" | jq -r '.html_url')" >> "$GITHUB_OUTPUT"
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build success message
        id: message
        env:
          PR_FOUND: ${{ steps.pr.outputs.found }}
          PR_NUM: ${{ steps.pr.outputs.number }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_URL: ${{ steps.pr.outputs.url }}
          VERSION: ${{ steps.version.outputs.version }}
          PYPI_SKIPPED: ${{ needs.publish.result == 'skipped' }}
          SERVER_URL: ${{ github.server_url }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          RUN_URL="${SERVER_URL}/${REPOSITORY}/actions/runs/${RUN_ID}"

          if [ "$PYPI_SKIPPED" = "true" ]; then
            PUBLISHED="Homebrew update triggered"
          else
            PUBLISHED="Published to <https://pypi.org/project/elspais/${VERSION}/|PyPI>"
          fi

          if [ "$PR_FOUND" = "true" ]; then
            MSG=":white_check_mark: *elspais v${VERSION} released*\n\n${PUBLISHED}\n*PR:* <${PR_URL}|#${PR_NUM} ${PR_TITLE}>\n*Run:* <${RUN_URL}|View run>"
          else
            MSG=":white_check_mark: *elspais v${VERSION} released*\n\n${PUBLISHED}\n*Run:* <${RUN_URL}|View run>"
          fi

          echo "text=${MSG}" >> "$GITHUB_OUTPUT"

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_APP_OATH_TOKEN }}
          errors: true
          payload: |
            channel: "${{ secrets.SLACK_CHANNEL_DEV }}"
            text: "${{ steps.message.outputs.text }}"

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [publish, update-homebrew]
    if: always() && (needs.publish.result == 'failure' || needs.update-homebrew.result == 'failure')
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Determine failed steps
        id: failures
        run: |
          FAILED=""
          if [ "${{ needs.publish.result }}" = "failure" ]; then
            FAILED="PyPI publish"
          fi
          if [ "${{ needs.update-homebrew.result }}" = "failure" ]; then
            [ -n "$FAILED" ] && FAILED="$FAILED and "
            FAILED="${FAILED}Homebrew update"
          fi
          echo "failed_steps=${FAILED}" >> "$GITHUB_OUTPUT"

      - name: Find triggering PR
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_JSON=$(gh api "repos/${{ github.repository }}/commits/${{ github.sha }}/pulls" \
            --jq '.[0] // empty' 2>/dev/null || echo "")

          if [ -n "$PR_JSON" ]; then
            LOGIN=$(echo "$PR_JSON" | jq -r '.user.login')
            echo "number=$(echo "$PR_JSON" | jq -r '.number')" >> "$GITHUB_OUTPUT"
            echo "title=$(echo "$PR_JSON" | jq -r '.title')" >> "$GITHUB_OUTPUT"
            echo "author=${LOGIN}" >> "$GITHUB_OUTPUT"
            echo "url=$(echo "$PR_JSON" | jq -r '.html_url')" >> "$GITHUB_OUTPUT"
            echo "found=true" >> "$GITHUB_OUTPUT"

            # Resolve display name from GitHub profile
            DISPLAY_NAME=$(gh api "users/${LOGIN}" --jq '.name // empty' 2>/dev/null || echo "")
            echo "author_name=${DISPLAY_NAME:-${LOGIN}}" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Lookup Slack user by email
        id: slack_user
        if: steps.pr.outputs.found == 'true'
        env:
          SLACK_TOKEN: ${{ secrets.SLACK_APP_OATH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          AUTHOR="${{ steps.pr.outputs.author }}"

          # Get email from GitHub profile
          EMAIL=$(gh api "users/${AUTHOR}" --jq '.email // empty' 2>/dev/null || echo "")

          # Fallback: try commit author email
          if [ -z "$EMAIL" ]; then
            EMAIL=$(gh api "repos/${{ github.repository }}/commits/${{ github.sha }}" \
              --jq '.commit.author.email // empty' 2>/dev/null || echo "")
          fi

          # Filter out noreply addresses
          if echo "$EMAIL" | grep -q 'noreply'; then
            EMAIL=""
          fi

          if [ -n "$EMAIL" ]; then
            SLACK_RESPONSE=$(curl -s -H "Authorization: Bearer ${SLACK_TOKEN}" \
              "https://slack.com/api/users.lookupByEmail?email=${EMAIL}")

            if [ "$(echo "$SLACK_RESPONSE" | jq -r '.ok')" = "true" ]; then
              echo "user_id=$(echo "$SLACK_RESPONSE" | jq -r '.user.id')" >> "$GITHUB_OUTPUT"
              echo "found=true" >> "$GITHUB_OUTPUT"
            else
              echo "found=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine Slack channel
        id: channel
        env:
          SLACK_USER_FOUND: ${{ steps.slack_user.outputs.found }}
          SLACK_USER_ID: ${{ steps.slack_user.outputs.user_id }}
          FALLBACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_DEV }}
        run: |
          if [ "$SLACK_USER_FOUND" = "true" ]; then
            echo "id=${SLACK_USER_ID}" >> "$GITHUB_OUTPUT"
          else
            echo "id=${FALLBACK_CHANNEL}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build notification message
        id: message
        env:
          GH_TOKEN: ${{ github.token }}
          PR_FOUND: ${{ steps.pr.outputs.found }}
          PR_NUM: ${{ steps.pr.outputs.number }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_URL: ${{ steps.pr.outputs.url }}
          PR_AUTHOR_NAME: ${{ steps.pr.outputs.author_name }}
          VERSION: ${{ steps.version.outputs.version }}
          FAILED_STEPS: ${{ steps.failures.outputs.failed_steps }}
          SERVER_URL: ${{ github.server_url }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          ACTOR: ${{ github.actor }}
        run: |
          RUN_URL="${SERVER_URL}/${REPOSITORY}/actions/runs/${RUN_ID}"

          # Resolve display name for actor fallback
          ACTOR_NAME=$(gh api "users/${ACTOR}" --jq '.name // empty' 2>/dev/null || echo "")
          ACTOR_NAME="${ACTOR_NAME:-${ACTOR}}"

          if [ "$PR_FOUND" = "true" ]; then
            MSG=":rotating_light: *Publish failed* for elspais v${VERSION}\n\n*Failed:* ${FAILED_STEPS}\n*PR:* <${PR_URL}|#${PR_NUM} ${PR_TITLE}>\n*Run:* <${RUN_URL}|View failed run>\n*Author:* ${PR_AUTHOR_NAME}"
          else
            MSG=":rotating_light: *Publish failed* for elspais v${VERSION}\n\n*Failed:* ${FAILED_STEPS}\n*Run:* <${RUN_URL}|View failed run>\n*Triggered by:* ${ACTOR_NAME}"
          fi

          echo "text=${MSG}" >> "$GITHUB_OUTPUT"

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_APP_OATH_TOKEN }}
          errors: true
          payload: |
            channel: "${{ steps.channel.outputs.id }}"
            text: "${{ steps.message.outputs.text }}"
