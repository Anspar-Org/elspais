# Temporary - delete after verifying Slack integration
name: Test Slack Notification

on:
  push:
    branches: [build-error-notice]
    paths: ['.github/workflows/test-slack-notification.yml']

jobs:
  test-notification:
    name: Test Slack Notification
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Find recent PR
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_JSON=$(gh api "repos/${{ github.repository }}/pulls?state=open&per_page=1" \
            --jq '.[0] // empty' 2>/dev/null || echo "")

          if [ -n "$PR_JSON" ]; then
            echo "number=$(echo "$PR_JSON" | jq -r '.number')" >> "$GITHUB_OUTPUT"
            echo "title=$(echo "$PR_JSON" | jq -r '.title')" >> "$GITHUB_OUTPUT"
            echo "author=$(echo "$PR_JSON" | jq -r '.user.login')" >> "$GITHUB_OUTPUT"
            echo "url=$(echo "$PR_JSON" | jq -r '.html_url')" >> "$GITHUB_OUTPUT"
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Lookup Slack user by email
        id: slack_user
        if: steps.pr.outputs.found == 'true'
        env:
          SLACK_TOKEN: ${{ secrets.SLACK_APP_OATH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          AUTHOR="${{ steps.pr.outputs.author }}"
          EMAIL=$(gh api "users/${AUTHOR}" --jq '.email // empty' 2>/dev/null || echo "")

          if [ -z "$EMAIL" ]; then
            EMAIL=$(gh api "repos/${{ github.repository }}/commits/${{ github.sha }}" \
              --jq '.commit.author.email // empty' 2>/dev/null || echo "")
          fi

          if echo "$EMAIL" | grep -q 'noreply'; then
            EMAIL=""
          fi

          echo "::notice::Email resolved: ${EMAIL:-none}"

          if [ -n "$EMAIL" ]; then
            SLACK_RESPONSE=$(curl -s -H "Authorization: Bearer ${SLACK_TOKEN}" \
              "https://slack.com/api/users.lookupByEmail?email=${EMAIL}")

            SLACK_OK=$(echo "$SLACK_RESPONSE" | jq -r '.ok')
            echo "::notice::Slack lookupByEmail ok: ${SLACK_OK}"

            if [ "$SLACK_OK" = "true" ]; then
              SLACK_USER_ID=$(echo "$SLACK_RESPONSE" | jq -r '.user.id')
              echo "user_id=${SLACK_USER_ID}" >> "$GITHUB_OUTPUT"
              echo "found=true" >> "$GITHUB_OUTPUT"
              echo "::notice::Slack user ID resolved: ${SLACK_USER_ID}"
            else
              SLACK_ERR=$(echo "$SLACK_RESPONSE" | jq -r '.error // empty')
              echo "::warning::Slack lookupByEmail error: ${SLACK_ERR}"
              echo "found=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "::warning::No usable email for ${AUTHOR}, falling back to channel"
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine Slack channel
        id: channel
        env:
          SLACK_USER_FOUND: ${{ steps.slack_user.outputs.found }}
          SLACK_USER_ID: ${{ steps.slack_user.outputs.user_id }}
          FALLBACK_CHANNEL: ${{ secrets.SLACK_FALLBACK_CHANNEL }}
        run: |
          if [ "$SLACK_USER_FOUND" = "true" ]; then
            echo "id=${SLACK_USER_ID}" >> "$GITHUB_OUTPUT"
            echo "::notice::Sending DM to Slack user"
          else
            echo "id=${FALLBACK_CHANNEL}" >> "$GITHUB_OUTPUT"
            echo "::notice::Falling back to channel"
          fi

      - name: Send test Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_4_GH }}
          errors: true
          payload: |
            channel: "${{ steps.channel.outputs.id }}"
            text: ":test_tube: *Test notification* from elspais publish workflow\n\nThis is a test to verify Slack integration works.\n*PR:* <${{ steps.pr.outputs.url }}|#${{ steps.pr.outputs.number }} ${{ steps.pr.outputs.title }}>\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View test run>"
