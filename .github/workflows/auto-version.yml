name: Auto Version Bump

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: read

jobs:
  version-bump:
    name: Auto Version Bump
    runs-on: ubuntu-latest
    # Skip if the PR was created by this workflow (prevent loops)
    if: github.actor != 'github-actions[bot]'
    timeout-minutes: 5

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Check if version already bumped
        id: check
        run: |
          # Get version from main branch
          MAIN_VERSION=$(git show origin/main:pyproject.toml | grep '^version' | head -1 | sed 's/.*"\(.*\)"/\1/')
          # Get version from PR branch
          PR_VERSION=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)"/\1/')

          echo "main_version=${MAIN_VERSION}" >> "$GITHUB_OUTPUT"
          echo "pr_version=${PR_VERSION}" >> "$GITHUB_OUTPUT"

          if [ "$MAIN_VERSION" != "$PR_VERSION" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Version already bumped: ${MAIN_VERSION} -> ${PR_VERSION}"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Version unchanged at ${MAIN_VERSION}, will auto-bump"
          fi

      - name: Determine bump type from changed files
        if: steps.check.outputs.skip == 'false'
        id: bump
        run: |
          # Get files changed vs main
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if ALL changes are docs/tests/specs only
          PATCH_ONLY=true
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            case "$file" in
              docs/*|tests/*|spec/*|*.md|.gitignore|.github/workflows/*)
                ;; # patch-level change
              *)
                PATCH_ONLY=false
                echo "  Minor-level change: $file"
                break
                ;;
            esac
          done <<< "$CHANGED_FILES"

          if [ "$PATCH_ONLY" = "true" ]; then
            echo "bump_type=patch" >> "$GITHUB_OUTPUT"
            echo "Bump type: patch (docs/tests/specs only)"
          else
            echo "bump_type=minor" >> "$GITHUB_OUTPUT"
            echo "Bump type: minor (source code changes)"
          fi

      - name: Compute new version
        if: steps.check.outputs.skip == 'false'
        id: version
        run: |
          CURRENT="${{ steps.check.outputs.main_version }}"
          BUMP_TYPE="${{ steps.bump.outputs.bump_type }}"

          # Parse major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          if [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Version bump: ${CURRENT} -> ${NEW_VERSION} (${BUMP_TYPE})"

      - name: Update pyproject.toml
        if: steps.check.outputs.skip == 'false'
        run: |
          CURRENT="${{ steps.check.outputs.main_version }}"
          NEW="${{ steps.version.outputs.new_version }}"
          sed -i "s/^version = \"${CURRENT}\"/version = \"${NEW}\"/" pyproject.toml
          echo "Updated pyproject.toml: ${CURRENT} -> ${NEW}"
          grep '^version' pyproject.toml

      - name: Commit version bump
        if: steps.check.outputs.skip == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          # Check if there's actually a change to commit
          if git diff --cached --quiet; then
            echo "No version change needed"
          else
            git commit -m "chore: auto-bump version to ${{ steps.version.outputs.new_version }}"
            git push
            echo "Committed and pushed version bump to ${{ steps.version.outputs.new_version }}"
          fi
