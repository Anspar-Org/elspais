#!/bin/bash
# =====================================================
# Pre-Push Hook: elspais Validation Suite
# =====================================================
#
# Runs validation before push with PR-aware blocking:
#   - Push to PR/feature branch: BLOCKS if validation fails
#   - Push to other branches: WARNS but allows push
#
# Validations:
#   - Documentation sync tests (pytest)
#   - Deprecated config options check
#   - CLI help verification
#   - Python code quality (ruff + black)
#   - Markdown linting (markdownlint)
#   - Secret detection (gitleaks)
#   - elspais self-validation on fixtures
#
# To install this hook:
#   git config core.hooksPath .githooks
#
# To bypass (NOT RECOMMENDED for PR branches):
#   git push --no-verify
#
# =====================================================

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the current branch
CURRENT_BRANCH=$(git branch --show-current)

# Skip validation for main/master branches (they should only receive validated PRs)
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
    echo -e "${BLUE}Skipping pre-push validation for protected branch '$CURRENT_BRANCH'${NC}"
    exit 0
fi

# =====================================================
# 1. Detect PR Status and PR-Intended Branches
# =====================================================

HAS_PR=false
PR_URL=""
IS_PR_INTENDED_BRANCH=false

# Check if branch name indicates it's intended for a PR
if [[ "$CURRENT_BRANCH" == feature/* ]] || \
   [[ "$CURRENT_BRANCH" == fix/* ]] || \
   [[ "$CURRENT_BRANCH" == release/* ]]; then
    IS_PR_INTENDED_BRANCH=true
fi

# Check if gh CLI is available
if command -v gh &> /dev/null; then
    if PR_INFO=$(gh pr view "$CURRENT_BRANCH" --json url,state 2>/dev/null); then
        PR_STATE=$(echo "$PR_INFO" | jq -r '.state' 2>/dev/null)
        if [ "$PR_STATE" = "OPEN" ]; then
            HAS_PR=true
            PR_URL=$(echo "$PR_INFO" | jq -r '.url' 2>/dev/null)
        fi
    fi
fi

# PR-intended branches should be blocking even before PR exists
SHOULD_BLOCK=$HAS_PR
if [ "$IS_PR_INTENDED_BRANCH" = true ]; then
    SHOULD_BLOCK=true
fi

# =====================================================
# 2. Start Validation
# =====================================================

echo ""
echo -e "${BLUE}======================================${NC}"
echo -e "${BLUE}  elspais Pre-Push Validation${NC}"
echo -e "${BLUE}======================================${NC}"
echo ""

if [ "$SHOULD_BLOCK" = true ]; then
    if [ "$HAS_PR" = true ]; then
        echo -e "${BLUE}Branch '$CURRENT_BRANCH' has open PR:${NC}"
        echo -e "${BLUE}  $PR_URL${NC}"
    elif [ "$IS_PR_INTENDED_BRANCH" = true ]; then
        echo -e "${BLUE}Branch '$CURRENT_BRANCH' is a PR-intended branch.${NC}"
    fi
    echo -e "${RED}Validation failures will BLOCK this push.${NC}"
else
    echo -e "${YELLOW}Branch '$CURRENT_BRANCH' has no open PR.${NC}"
    echo -e "${YELLOW}Validation failures will show warnings only.${NC}"
fi
echo ""

VALIDATION_FAILED=false

# =====================================================
# 3. Documentation Sync Tests
# =====================================================

echo -e "${BLUE}Running documentation sync tests...${NC}"
echo ""

if ! pytest tests/test_doc_sync.py -v --tb=short 2>&1; then
    VALIDATION_FAILED=true
    echo -e "${RED}Documentation sync tests failed!${NC}"
else
    echo -e "${GREEN}Documentation sync tests passed!${NC}"
fi
echo ""

# =====================================================
# 4. Deprecated Config Options Check
# =====================================================

echo -e "${BLUE}Checking for deprecated config options...${NC}"

if grep -r "require_acceptance" src/ docs/ --include="*.py" --include="*.md" --include="*.toml" 2>/dev/null | grep -v "deprecated\|legacy\|test_doc"; then
    echo -e "${RED}ERROR: Found deprecated 'require_acceptance' in production code/docs${NC}"
    VALIDATION_FAILED=true
else
    echo -e "${GREEN}No deprecated options found${NC}"
fi
echo ""

# =====================================================
# 5. CLI Help Verification
# =====================================================

echo -e "${BLUE}Verifying CLI help...${NC}"

if ! python3 -m elspais --help > /dev/null 2>&1; then
    echo -e "${RED}CLI help verification failed!${NC}"
    VALIDATION_FAILED=true
else
    echo -e "${GREEN}CLI help verification passed${NC}"
fi
echo ""

# =====================================================
# 6. Python Code Quality (Full Check)
# =====================================================

echo -e "${BLUE}Checking Python code quality...${NC}"
echo ""

# Run ruff on entire src directory
if command -v ruff &> /dev/null; then
    echo "  Running ruff check src/..."
    if ! ruff check src/elspais 2>&1; then
        VALIDATION_FAILED=true
        echo -e "${RED}  ruff check failed${NC}"
    else
        echo -e "${GREEN}  ruff check passed${NC}"
    fi
else
    echo -e "${YELLOW}  WARNING: ruff not installed${NC}"
fi

# Run black check on entire src directory
if command -v black &> /dev/null; then
    echo "  Running black check src/..."
    if ! black --check src/elspais 2>&1; then
        VALIDATION_FAILED=true
        echo -e "${RED}  black check failed${NC}"
    else
        echo -e "${GREEN}  black check passed${NC}"
    fi
else
    echo -e "${YELLOW}  WARNING: black not installed${NC}"
fi
echo ""

# =====================================================
# 7. Markdown Linting
# =====================================================

# Get repo root
REPO_ROOT=$(git rev-parse --show-toplevel)

# Get list of markdown files that will be pushed
REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")

if [ -n "$REMOTE_BRANCH" ]; then
    MARKDOWN_FILES_CHANGED=$(git diff --name-only "$REMOTE_BRANCH"...HEAD 2>/dev/null | grep '\.md$' || true)
else
    MARKDOWN_FILES_CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '\.md$' || true)
fi

if [ -n "$MARKDOWN_FILES_CHANGED" ]; then
    echo -e "${BLUE}Running markdown linting...${NC}"
    echo ""

    if command -v markdownlint &> /dev/null; then
        # Filter to only files that exist
        EXISTING_FILES=""
        while IFS= read -r file; do
            if [ -f "$REPO_ROOT/$file" ]; then
                EXISTING_FILES+="$REPO_ROOT/$file"$'\n'
            fi
        done <<< "$MARKDOWN_FILES_CHANGED"

        if [ -n "$EXISTING_FILES" ]; then
            MDLINT_CONFIG=""
            if [ -f "$REPO_ROOT/.markdownlint.json" ]; then
                MDLINT_CONFIG="--config $REPO_ROOT/.markdownlint.json"
            fi

            if ! echo "$EXISTING_FILES" | xargs markdownlint $MDLINT_CONFIG 2>&1; then
                VALIDATION_FAILED=true
                echo -e "${RED}Markdown linting failed!${NC}"
            else
                echo -e "${GREEN}Markdown linting passed!${NC}"
            fi
        fi
    else
        echo -e "${YELLOW}WARNING: markdownlint not installed - skipping${NC}"
        echo "  Install: npm install -g markdownlint-cli"
    fi
    echo ""
else
    echo -e "${BLUE}No markdown files changed - skipping markdown linting${NC}"
    echo ""
fi

# =====================================================
# 8. Secret Detection (Gitleaks)
# =====================================================

echo -e "${BLUE}Running secret detection...${NC}"
echo ""

if command -v gitleaks &> /dev/null; then
    if [ -n "$REMOTE_BRANCH" ]; then
        if ! gitleaks detect --source="$REPO_ROOT" --log-opts="$REMOTE_BRANCH..HEAD" --no-banner --redact 2>&1; then
            VALIDATION_FAILED=true
            echo -e "${RED}Gitleaks detected secrets!${NC}"
            echo -e "${RED}Remove secrets before pushing.${NC}"
        else
            echo -e "${GREEN}No secrets detected!${NC}"
        fi
    else
        if ! gitleaks detect --source="$REPO_ROOT" --no-banner --redact 2>&1; then
            VALIDATION_FAILED=true
            echo -e "${RED}Gitleaks detected secrets!${NC}"
        else
            echo -e "${GREEN}No secrets detected!${NC}"
        fi
    fi
else
    echo -e "${YELLOW}WARNING: gitleaks not installed - skipping secret detection${NC}"
    echo "  Install: https://github.com/gitleaks/gitleaks#installing"
fi
echo ""

# =====================================================
# 9. elspais Self-Validation on Fixtures
# =====================================================

echo -e "${BLUE}Running elspais validation on test fixtures...${NC}"
echo ""

# Test on a few fixture directories
FIXTURE_DIRS=(
    "tests/fixtures/hht-like"
    "tests/fixtures/assertions"
)

for fixture_dir in "${FIXTURE_DIRS[@]}"; do
    if [ -d "$REPO_ROOT/$fixture_dir" ]; then
        echo "  Validating $fixture_dir..."
        if ! (cd "$REPO_ROOT/$fixture_dir" && python3 -m elspais validate 2>&1); then
            # Some fixtures have intentional errors, so just warn
            echo -e "${YELLOW}  Warning: validation issues in $fixture_dir${NC}"
        else
            echo -e "${GREEN}  $fixture_dir OK${NC}"
        fi
    fi
done
echo ""

# =====================================================
# 10. Full Test Suite
# =====================================================

echo -e "${BLUE}Running full test suite...${NC}"
echo ""

if ! pytest tests/ --tb=short -q 2>&1; then
    VALIDATION_FAILED=true
    echo -e "${RED}Test suite failed!${NC}"
else
    echo -e "${GREEN}Test suite passed!${NC}"
fi
echo ""

# =====================================================
# 11. Handle Validation Results
# =====================================================

echo ""
echo -e "${BLUE}======================================${NC}"
echo -e "${BLUE}  Validation Summary${NC}"
echo -e "${BLUE}======================================${NC}"
echo ""

if [ "$VALIDATION_FAILED" = true ]; then
    if [ "$SHOULD_BLOCK" = true ]; then
        echo -e "${RED}VALIDATION FAILED${NC}"
        echo ""
        if [ "$HAS_PR" = true ]; then
            echo -e "${RED}Push BLOCKED because branch has an open PR.${NC}"
        elif [ "$IS_PR_INTENDED_BRANCH" = true ]; then
            echo -e "${RED}Push BLOCKED because this is a PR-intended branch.${NC}"
        fi
        echo ""
        echo "To fix:"
        echo "  1. Review the validation errors above"
        echo "  2. Fix the issues"
        echo "  3. Commit the fixes"
        echo "  4. Push again"
        echo ""
        echo -e "${YELLOW}To bypass (NOT RECOMMENDED):${NC}"
        echo "  git push --no-verify"
        echo ""
        exit 1
    else
        echo -e "${YELLOW}VALIDATION FAILED (warnings only)${NC}"
        echo ""
        echo -e "${YELLOW}Push ALLOWED because branch has no open PR.${NC}"
        echo -e "${YELLOW}Fix these issues before creating a PR.${NC}"
        echo ""
        exit 0
    fi
else
    echo -e "${GREEN}ALL VALIDATIONS PASSED${NC}"
    echo ""
    exit 0
fi
