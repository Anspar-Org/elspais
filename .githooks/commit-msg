#!/bin/bash
# =====================================================
# Commit-Msg Hook: elspais
# =====================================================
#
# Validates commit message format:
#   - Must start with [TICKET-NUMBER] (e.g., [CUR-514])
#   - Ticket format: [XXX-NNN] where XXX is 2-10 uppercase letters
#
# To install this hook:
#   git config core.hooksPath .githooks
#
# To bypass (NOT RECOMMENDED):
#   git commit --no-verify
#
# =====================================================

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Read the commit message
COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Get the first line (subject)
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)

# =====================================================
# Skip validation for certain commit types
# =====================================================

# Skip for merge commits
if echo "$FIRST_LINE" | grep -qE "^Merge (branch|pull request|remote-tracking)"; then
    exit 0
fi

# Skip for revert commits
if echo "$FIRST_LINE" | grep -qE "^Revert "; then
    exit 0
fi

# Skip for fixup/squash commits (used during interactive rebase)
if echo "$FIRST_LINE" | grep -qE "^(fixup|squash)! "; then
    exit 0
fi

# =====================================================
# Validate commit message format
# =====================================================

# Pattern: [XXX-NNN] where XXX is 2-10 uppercase letters, NNN is 1+ digits
TICKET_PATTERN='^\[[A-Z]{2,10}-[0-9]+\]'

if ! echo "$FIRST_LINE" | grep -qE "$TICKET_PATTERN"; then
    echo ""
    echo -e "${RED}ERROR: Commit message must start with a ticket number!${NC}"
    echo ""
    echo "Expected format: [TICKET-NUMBER] description"
    echo "  Example: [CUR-514] fix: Add validation for user input"
    echo "  Example: [PROJ-123] feat: Implement new feature"
    echo ""
    echo "Your commit message:"
    echo -e "  ${YELLOW}$FIRST_LINE${NC}"
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}Commit message format validated!${NC}"
exit 0
