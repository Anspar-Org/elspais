#!/bin/bash
# =====================================================
# Pre-Commit Hook: elspais
# =====================================================
#
# Validates code quality before commits:
#   - Branch protection (blocks commits to main/master)
#   - Python code quality (ruff + black)
#   - Markdown linting (markdownlint)
#
# To install this hook:
#   git config core.hooksPath .githooks
#
# To bypass (NOT RECOMMENDED):
#   git commit --no-verify
#
# =====================================================

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# =====================================================
# 1. Branch Protection - Block Commits to Main
# =====================================================

CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
    echo -e "${RED}ERROR: Direct commits to '$CURRENT_BRANCH' branch are not allowed!${NC}"
    echo ""
    echo "This repository enforces a feature branch workflow."
    echo "All changes must go through pull requests."
    echo ""
    echo "To fix this:"
    echo "  1. Create a feature branch: git checkout -b fix/your-fix-name"
    echo "  2. Commit your changes to the feature branch"
    echo "  3. Push and create a pull request"
    echo ""
    exit 1
fi

# =====================================================
# 2. Python Code Quality (ruff + black)
# =====================================================

PYTHON_FILES_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$PYTHON_FILES_CHANGED" ]; then
    echo -e "${BLUE}Checking Python code quality...${NC}"
    echo ""

    PYTHON_FAILED=false

    # Run ruff if available
    if command -v ruff &> /dev/null; then
        echo "  Running ruff check..."
        if ! echo "$PYTHON_FILES_CHANGED" | xargs ruff check 2>&1; then
            PYTHON_FAILED=true
            echo -e "${RED}  ruff check failed${NC}"
        else
            echo -e "${GREEN}  ruff check passed${NC}"
        fi
    else
        echo -e "${YELLOW}  WARNING: ruff not installed - skipping${NC}"
    fi

    # Run black if available
    if command -v black &> /dev/null; then
        echo "  Running black check..."
        if ! echo "$PYTHON_FILES_CHANGED" | xargs black --check --quiet 2>&1; then
            echo -e "${YELLOW}  Files need formatting. Applying fixes...${NC}"
            echo "$PYTHON_FILES_CHANGED" | xargs black
            # Re-stage formatted files
            echo "$PYTHON_FILES_CHANGED" | xargs git add
            echo -e "${GREEN}  Formatted files have been staged${NC}"
        else
            echo -e "${GREEN}  black check passed${NC}"
        fi
    else
        echo -e "${YELLOW}  WARNING: black not installed - skipping${NC}"
    fi

    if [ "$PYTHON_FAILED" = true ]; then
        echo ""
        echo -e "${RED}Python code quality checks failed!${NC}"
        echo "Fix the errors above before committing."
        echo ""
        echo "To bypass this check (NOT RECOMMENDED):"
        echo "  git commit --no-verify"
        exit 1
    fi

    echo ""
fi

# =====================================================
# 3. Markdown Linting
# =====================================================

MARKDOWN_FILES_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)

if [ -n "$MARKDOWN_FILES_CHANGED" ]; then
    echo -e "${BLUE}Linting markdown files...${NC}"
    echo ""

    if command -v markdownlint &> /dev/null; then
        # Check if config exists
        MDLINT_CONFIG=""
        if [ -f ".markdownlint.json" ]; then
            MDLINT_CONFIG="--config .markdownlint.json"
        fi

        if ! echo "$MARKDOWN_FILES_CHANGED" | xargs markdownlint $MDLINT_CONFIG 2>&1; then
            echo ""
            echo -e "${RED}Markdown linting failed!${NC}"
            echo "Fix the errors above before committing."
            echo ""
            echo "To bypass this check (NOT RECOMMENDED):"
            echo "  git commit --no-verify"
            exit 1
        fi

        echo -e "${GREEN}Markdown linting passed!${NC}"
        echo ""
    else
        echo -e "${YELLOW}WARNING: markdownlint not installed - skipping${NC}"
        echo "  Install: npm install -g markdownlint-cli"
        echo ""
    fi
fi

# =====================================================
# All Validations Passed
# =====================================================

echo -e "${GREEN}Pre-commit checks passed!${NC}"
exit 0
