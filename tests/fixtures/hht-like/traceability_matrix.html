<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Requirements Traceability Matrix</title>

    <style>
        /**
 * TraceView Interactive Traceability Matrix Styles
 *
 * This stylesheet contains all CSS for the trace-view HTML report.
 * Organized by component for maintainability.
 *
 * IMPLEMENTS REQUIREMENTS:
 *   REQ-tv-d00002: CSS Extraction
 */

/* ==========================================================================
   Base Layout
   ========================================================================== */

body {
    font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    font-size: 13px;
    line-height: 1.4;
    margin: 0;
    padding: 0;
    background: #f8f9fa;
    height: 100vh;
    overflow: hidden;
}

.app-layout {
    display: flex;
    height: 100vh;
    overflow: hidden;
}

.main-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    min-width: 0;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

/* ==========================================================================
   Typography
   ========================================================================== */

h1 {
    font-size: 20px;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 2px solid #0066cc;
    padding-bottom: 8px;
    margin: 0 0 15px 0;
}

h2 {
    font-size: 16px;
    font-weight: 600;
    color: #34495e;
    margin: 20px 0 10px 0;
}

/* ==========================================================================
   Title Bar
   ========================================================================== */

.title-bar {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 10px 0;
    border-bottom: 2px solid #0066cc;
    margin-bottom: 10px;
}

.title-bar h1 {
    font-size: 18px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
    border: none;
    padding: 0;
}

.version-badge {
    font-size: 10px;
    color: #6c757d;
    background: #e9ecef;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: monospace;
}

.stats-badges {
    display: flex;
    gap: 10px;
    margin-right: auto;
}

.stat-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    color: white;
}

.stat-badge.prd { background: #0066cc; }
.stat-badge.ops { background: #fd7e14; }
.stat-badge.dev { background: #28a745; }

/* Clickable stat badges */
.stat-badge {
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s, opacity 0.1s;
}

.stat-badge:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

.stat-badge.active {
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    transform: scale(0.98);
}

/* Hidden state for toggle filters - hollow button (visible through) */
.stat-badge.filter-hidden {
    background: transparent !important;
    border: 2px solid currentColor;
    color: #6c757d;
}

.stat-badge.prd.filter-hidden { border-color: #0066cc; color: #0066cc; }
.stat-badge.ops.filter-hidden { border-color: #fd7e14; color: #fd7e14; }
.stat-badge.dev.filter-hidden { border-color: #28a745; color: #28a745; }
.stat-badge.repo-badge.filter-hidden { border-color: #6c757d; color: #6c757d; }

/* Repo badges (CORE, CAL, TTN, etc.) - default purple */
.stat-badge.repo-badge {
    background: #6f42c1;
}

.stat-badge-separator {
    color: #6c757d;
    font-weight: bold;
    display: flex;
    align-items: center;
}

/* Files badge - teal color for implementation files */
.stat-badge.files-badge {
    background: #20c997;
}

.stat-badge.files-badge.filter-hidden {
    border-color: #20c997;
    color: #20c997;
}

/* ==========================================================================
   Buttons
   ========================================================================== */

.btn {
    padding: 6px 12px;
    border: none;
    border-radius: 3px;
    background: #0066cc;
    color: white;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: background 0.15s;
}

.btn:hover {
    background: #0052a3;
}

.btn-secondary {
    background: #6c757d;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-secondary.active {
    background: #0066cc;
}

.btn-secondary.active:hover {
    background: #0052a3;
}

.btn-legend {
    background: #6c757d;
    font-size: 12px;
}

.btn-legend:hover {
    background: #5a6268;
}

/* Toggle buttons */
.toggle-btn {
    background: white;
    color: #495057;
    border: 1px solid #28a745;
}

.toggle-btn:hover {
    background: #e8f5e9;
}

.toggle-btn.active {
    background: #28a745;
    color: white;
    border: 1px solid #28a745;
}

/* Edit Mode button - blue theme */
#btnEditMode {
    border: 1px solid #007bff;
}

#btnEditMode:hover {
    background: #e3f2fd;
}

#btnEditMode.active {
    background: #007bff;
    color: white;
    border: 1px solid #007bff;
}

/* ==========================================================================
   Controls & Filters
   ========================================================================== */

.controls {
    margin: 15px 0;
    padding: 10px;
    background: #e9ecef;
    border-radius: 4px;
    display: flex;
    gap: 8px;
    align-items: center;
}

.filter-controls {
    margin: 15px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
    display: flex;
    gap: 10px;
    align-items: center;
}

.filter-stats {
    margin-left: auto;
    font-size: 11px;
    color: #6c757d;
    font-weight: 500;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: #495057;
    cursor: pointer;
    padding: 6px 10px;
    background: #e9ecef;
    border-radius: 3px;
}

.checkbox-label:hover {
    background: #dee2e6;
}

.checkbox-label input {
    cursor: pointer;
}

/* View Toggle */
.view-toggle {
    display: flex;
    gap: 0;
    margin-right: 15px;
    border-radius: 4px;
    overflow: hidden;
}

.view-btn {
    border-radius: 0;
    border: 1px solid #0066cc;
    background: white;
    color: #0066cc;
}

.view-btn:first-child {
    border-radius: 4px 0 0 4px;
}

.view-btn:last-child {
    border-radius: 0 4px 4px 0;
    border-left: none;
}

.view-btn.active {
    background: #0066cc;
    color: white;
}

.view-btn:hover:not(.active) {
    background: #e6f0ff;
}

/* Filter Header */
.filter-header {
    display: grid;
    grid-template-columns: 110px minmax(100px, 1fr) 45px 90px 35px 50px 180px 110px;
    align-items: center;
    gap: 6px;
    padding: 8px 10px 8px 42px;
    background: #e9ecef;
    border-bottom: 2px solid #dee2e6;
    margin-bottom: 8px;
    position: sticky;
    top: 0;
    z-index: 10;
    min-width: 700px;
}

.filter-column {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.filter-column-multi .filter-row {
    display: flex;
    gap: 4px;
}

.filter-column-multi .filter-row select {
    flex: 1;
    min-width: 0;
}

.filter-label {
    font-size: 10px;
    font-weight: 600;
    color: #495057;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-column input, .filter-column select {
    padding: 3px 6px;
    border: 1px solid #ced4da;
    border-radius: 2px;
    font-size: 11px;
    background: white;
    width: 100%;
    box-sizing: border-box;
}

.filter-column input::placeholder {
    color: #adb5bd;
    font-size: 10px;
}

/* ==========================================================================
   Requirement Tree
   ========================================================================== */

.req-tree {
    margin: 15px 0;
    overflow-x: auto;
}

.req-item {
    margin: 2px 0;
    background: #ffffff;
    border-left: 3px solid #28a745;
    overflow: hidden;
}

.req-item.prd { border-left-color: #0066cc; }
.req-item.ops { border-left-color: #fd7e14; }
.req-item.dev { border-left-color: #28a745; }
.req-item.deprecated { opacity: 0.6; }

.req-header-container {
    padding: 6px 10px;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 8px;
}

.req-header-container:hover {
    background: #f8f9fa;
}

/* Indentation based on hierarchy level */
.req-item[data-indent="0"] .req-header-container { padding-left: 10px; }
.req-item[data-indent="1"] .req-header-container { padding-left: 30px; }
.req-item[data-indent="2"] .req-header-container { padding-left: 50px; }
.req-item[data-indent="3"] .req-header-container { padding-left: 70px; }
.req-item[data-indent="4"] .req-header-container { padding-left: 90px; }
.req-item[data-indent="5"] .req-header-container { padding-left: 110px; }
.req-item[data-indent="6"] .req-header-container,
.req-item[data-indent="7"] .req-header-container,
.req-item[data-indent="8"] .req-header-container,
.req-item[data-indent="9"] .req-header-container { padding-left: 110px; }

.collapse-icon {
    font-size: 10px;
    color: #6c757d;
    transition: transform 0.15s;
    flex-shrink: 0;
    width: 12px;
    text-align: center;
}

.collapse-icon.collapsed {
    transform: rotate(-90deg);
}

.req-content {
    flex: 1;
    display: grid;
    grid-template-columns: 110px minmax(100px, 1fr) 45px 90px 35px 50px 180px 110px;
    align-items: start;
    gap: 6px;
    min-width: 700px;
}

.req-id {
    font-weight: 600;
    color: #0066cc;
    font-size: 12px;
    font-family: 'Consolas', 'Monaco', monospace;
    flex-shrink: 0;
}

/* Conflict marker (asterisk) for conflicting requirements */
.conflict-marker {
    color: #dc3545;
    font-weight: bold;
    font-size: 14px;
    margin-left: 1px;
}

.req-header {
    font-weight: 500;
    color: #2c3e50;
    font-size: 13px;
    /* Allow titles to wrap on narrow windows */
    word-wrap: break-word;
    overflow-wrap: break-word;
    min-width: 0;
}

.req-level {
    font-size: 11px;
    color: #7f8c8d;
    text-align: center;
}

.req-badges {
    display: flex;
    gap: 4px;
    align-items: center;
}

.req-status {
    font-size: 11px;
    color: #7f8c8d;
    text-align: center;
}

.req-location {
    font-size: 11px;
    color: #7f8c8d;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.req-coverage {
    min-width: 30px;
    max-width: 40px;
    text-align: center;
    font-size: 14px;
}

/* Implementation files */
.req-item.impl-file {
    border-left: 3px solid #6c757d;
    background: #f8f9fa;
}

.req-item.impl-file .req-header-container {
    cursor: default;
}

.req-item.impl-file .req-header-container:hover {
    background: #f0f0f0;
}

/* Collapsed items */
.req-item.collapsed-by-parent {
    display: none;
}

/* View modes */
.req-tree.flat-view .req-item .req-header-container {
    padding-left: 10px !important;
}

.req-tree.hierarchy-view .req-item:not([data-is-root="true"]) {
    display: none;
}

.req-tree.hierarchy-view .req-item[data-is-root="true"] {
    display: block;
}

.req-tree.hierarchy-view .req-item.hierarchy-visible {
    display: block;
}

.req-tree.hierarchy-view .req-item.hierarchy-visible.collapsed-by-parent {
    display: none;
}

.req-item.filtered-out {
    display: none !important;
}

/* ==========================================================================
   Status Badges
   ========================================================================== */

.status-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 2px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.status-active { background: #d4edda; color: #155724; }
.status-draft { background: #fff3cd; color: #856404; }
.status-deprecated { background: #f8d7da; color: #721c24; }

.status-suffix {
    font-weight: bold;
    font-size: 12px;
    margin-left: 1px;
    cursor: help;
}

.status-new { color: #28a745; }
.status-modified { color: #fd7e14; }
.status-moved { color: #6f42c1; }
.status-moved-modified { color: #6f42c1; }
.status-pending-move { color: #007bff; }

/* Test badges */
.test-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 2px;
    font-size: 10px;
    font-weight: 600;
}

.test-passed { background: #d4edda; color: #155724; }
.test-failed { background: #f8d7da; color: #721c24; }
.test-not-tested { background: #fff3cd; color: #856404; }
.test-error { background: #f5c2c7; color: #842029; }
.test-skipped { background: #e2e3e5; color: #41464b; }

.coverage-badge {
    display: inline-block;
    font-size: 14px;
    cursor: help;
}

/* ==========================================================================
   Issue Indicators
   ========================================================================== */

.roadmap-icon {
    margin-left: 4px;
    font-size: 12px;
    opacity: 0.8;
}

.conflict-icon {
    margin-right: 4px;
    font-size: 14px;
    color: #dc3545;
}

.conflict-item {
    background-color: rgba(220, 53, 69, 0.1) !important;
    border-left: 3px solid #dc3545 !important;
}

.conflict-item:hover {
    background-color: rgba(220, 53, 69, 0.15) !important;
}

.cycle-icon {
    margin-right: 4px;
    font-size: 14px;
    color: #fd7e14;
}

.cycle-item {
    background-color: rgba(253, 126, 20, 0.1) !important;
    border-left: 3px solid #fd7e14 !important;
}

.cycle-item:hover {
    background-color: rgba(253, 126, 20, 0.15) !important;
}

/* ==========================================================================
   Edit Mode
   ========================================================================== */

.edit-mode-panel {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    padding: 15px;
    margin: 10px 0;
}

.edit-mode-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.edit-mode-title {
    font-size: 14px;
}

.edit-mode-actions {
    display: flex;
    gap: 10px;
}

.pending-moves-list {
    max-height: 200px;
    overflow-y: auto;
    font-size: 12px;
}

.pending-move-item {
    padding: 5px 10px;
    background: white;
    border-radius: 3px;
    margin: 3px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.edit-actions {
    display: none;
}

body.edit-mode-active .edit-actions {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.edit-btn {
    padding: 2px 6px;
    font-size: 10px;
    cursor: pointer;
    border: 1px solid #ccc;
    border-radius: 3px;
    background: white;
    white-space: nowrap;
}

.edit-btn:hover {
    background: #e9ecef;
}

.edit-btn.to-roadmap {
    border-color: #fd7e14;
    color: #fd7e14;
}

.edit-btn.from-roadmap {
    border-color: #28a745;
    color: #28a745;
}

.edit-btn.move-file {
    border-color: #007bff;
    color: #007bff;
}

.edit-mode-column {
    display: none;
}

body.edit-mode-active .edit-mode-column {
    display: block;
}

.req-destination {
    min-width: 100px;
    max-width: 150px;
    font-size: 11px;
    padding: 2px 6px;
}

.req-destination:not(:empty) {
    background: #e8f4fd;
    border-radius: 4px;
    color: #0366d6;
    font-weight: 500;
}

.req-destination.to-roadmap {
    background: #fff3cd;
    color: #856404;
}

.req-destination.from-roadmap {
    background: #d4edda;
    color: #155724;
}

.dest-text {
    font-size: 11px;
    color: #666;
    white-space: nowrap;
}

/* Panel/card edit buttons */
.req-card-actions {
    display: flex !important;
    flex-direction: row;
    gap: 8px;
    margin: 8px 0;
}

.panel-edit-btn {
    font-size: 11px;
    padding: 4px 8px;
}

/* ==========================================================================
   VS Code Link
   ========================================================================== */

.vscode-link {
    font-size: 16px;
    color: #007acc;
    text-decoration: none;
    margin-left: 6px;
}

.vscode-link:hover {
    color: #005a9e;
}

/* ==========================================================================
   Legend
   ========================================================================== */

.level-legend {
    display: flex;
    gap: 15px;
    margin: 15px 0;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 12px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 2px;
}

.legend-color.prd { background: #0066cc; }
.legend-color.ops { background: #fd7e14; }
.legend-color.dev { background: #28a745; }

/* ==========================================================================
   Side Panel (REQ-tv-d00002-B: _generate_side_panel_css)
   ========================================================================== */

.side-panel {
    width: 400px;
    min-width: 250px;
    max-width: 70vw;
    height: 100vh;
    background: white;
    border-left: 2px solid #dee2e6;
    box-shadow: -2px 0 8px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
}

.side-panel.hidden {
    display: none;
}

.resize-handle {
    position: absolute;
    left: -4px;
    top: 0;
    width: 8px;
    height: 100%;
    cursor: col-resize;
    background: transparent;
    z-index: 10;
}

.resize-handle:hover,
.resize-handle.dragging {
    background: rgba(0, 102, 204, 0.3);
}

.panel-header {
    padding: 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    font-size: 14px;
}

.panel-header button {
    padding: 4px 8px;
    font-size: 11px;
    border: none;
    background: #dc3545;
    color: white;
    border-radius: 3px;
    cursor: pointer;
}

.panel-header button:hover {
    background: #c82333;
}

#req-card-stack {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.req-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 10px;
    overflow: hidden;
}

.req-card-header {
    background: #e9ecef;
    padding: 10px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
}

.req-card-title {
    font-weight: 600;
    font-size: 12px;
    color: #2c3e50;
}

.close-btn {
    background: none;
    border: none;
    font-size: 20px;
    color: #6c757d;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    line-height: 20px;
}

.close-btn:hover {
    color: #dc3545;
}

.req-card-body {
    padding: 12px;
}

.req-card-meta {
    display: flex;
    gap: 6px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.req-card-meta .badge {
    display: inline-block;
    padding: 2px 6px;
    background: #0066cc;
    color: white;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
}

.req-card-meta .file-ref {
    font-size: 10px;
    color: #6c757d;
    font-family: 'Consolas', 'Monaco', monospace;
}

.file-ref-link {
    font-size: 10px;
    color: #0066cc;
    font-family: 'Consolas', 'Monaco', monospace;
    text-decoration: none;
}

.file-ref-link:hover {
    text-decoration: underline;
}

.req-card-implements {
    font-size: 11px;
    color: #6c757d;
    margin-bottom: 10px;
    padding: 6px 8px;
    background: #f8f9fa;
    border-radius: 3px;
}

.req-card-implements .implements-link {
    color: #0066cc;
    text-decoration: none;
}

.req-card-implements .implements-link:hover {
    text-decoration: underline;
}

.req-card-content {
    font-size: 13px;
    line-height: 1.6;
}

.req-body {
    margin-bottom: 10px;
}

.req-rationale {
    padding: 8px;
    background: #fff3cd;
    border-left: 3px solid #ffc107;
    font-size: 12px;
}

/* ==========================================================================
   Line-numbered content (REQ panel)
   ========================================================================== */

.rs-lined-content {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

.rs-section-label {
    margin: 0 0 8px 0;
    padding: 0;
    font-size: 11px;
    font-weight: 600;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.req-body-section {
    margin-bottom: 16px;
}

.req-rationale-section {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid #eee;
}

/* Table-based layout for line numbers */
.rs-lines-table {
    display: table;
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    line-height: 1.5;
    background: #fafafa;
    border-radius: 4px;
    overflow: hidden;
}

.rs-line-row {
    display: table-row;
}

.rs-line-row:hover {
    background: rgba(0, 102, 204, 0.05);
}

.rs-line-number {
    display: table-cell;
    padding: 2px 8px 2px 6px;
    text-align: right;
    color: #999;
    background: #e9ecef;
    border-right: 1px solid #ddd;
    user-select: none;
    vertical-align: top;
    min-width: 32px;
    width: 32px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 11px;
}

.rs-line-text {
    display: table-cell;
    padding: 2px 10px;
    vertical-align: top;
    word-break: break-word;
    white-space: pre-wrap;
}

/* Markdown formatting within line text */
.rs-line-text strong {
    font-weight: 700;
}

.rs-line-text em {
    font-style: italic;
}

.rs-line-text code {
    background: rgba(0, 0, 0, 0.06);
    padding: 0.1em 0.3em;
    border-radius: 3px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.9em;
}

.rs-line-text .md-heading {
    font-weight: 700;
    color: #333;
}

.rs-line-text .md-h1 { font-size: 1.3em; }
.rs-line-text .md-h2 { font-size: 1.2em; }
.rs-line-text .md-h3 { font-size: 1.1em; }
.rs-line-text .md-h4,
.rs-line-text .md-h5,
.rs-line-text .md-h6 { font-size: 1em; }

.rs-line-text .md-list-item {
    display: inline-block;
    width: 100%;
    padding-left: 2em;
    text-indent: -2em;
    box-sizing: border-box;
    vertical-align: top;
    white-space: normal;
}

/* Markdown content styling */
.markdown-body p {
    margin: 0 0 10px 0;
}

.markdown-body ul, .markdown-body ol {
    margin: 0 0 10px 0;
    padding-left: 20px;
}

.markdown-body li {
    margin: 4px 0;
}

.markdown-body code {
    background: #f4f4f4;
    padding: 2px 5px;
    border-radius: 3px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 12px;
}

.markdown-body pre {
    background: #2d2d2d;
    color: #ccc;
    padding: 10px;
    border-radius: 4px;
    overflow-x: auto;
    margin: 10px 0;
}

.markdown-body pre code {
    background: none;
    padding: 0;
    color: inherit;
}

.markdown-body strong {
    font-weight: 600;
}

.markdown-body em {
    font-style: italic;
}

.markdown-body h1, .markdown-body h2, .markdown-body h3 {
    margin: 15px 0 10px 0;
    font-weight: 600;
}

.markdown-body h1 { font-size: 18px; }
.markdown-body h2 { font-size: 16px; }
.markdown-body h3 { font-size: 14px; }

.markdown-body blockquote {
    margin: 10px 0;
    padding: 8px 12px;
    border-left: 3px solid #dee2e6;
    background: #f8f9fa;
    color: #6c757d;
}

.markdown-body a {
    color: #0066cc;
    text-decoration: none;
}

.markdown-body a:hover {
    text-decoration: underline;
}

.markdown-body table {
    border-collapse: collapse;
    margin: 10px 0;
    width: 100%;
}

.markdown-body th, .markdown-body td {
    border: 1px solid #dee2e6;
    padding: 6px 10px;
    text-align: left;
}

.markdown-body th {
    background: #f8f9fa;
    font-weight: 600;
}

/* ==========================================================================
   Code Viewer Modal (REQ-tv-d00002-B: _generate_code_viewer_css)
   ========================================================================== */

.code-viewer-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 2000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.code-viewer-modal.hidden {
    display: none;
}

.code-viewer-container {
    width: 85%;
    height: 85%;
    background: #1e1e1e;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}

.code-viewer-header {
    background: #333;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #444;
}

.code-viewer-title {
    color: #e0e0e0;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 14px;
}

.code-viewer-line {
    color: #888;
    font-size: 12px;
    margin-left: 15px;
}

.code-viewer-close {
    background: #dc3545;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.code-viewer-close:hover {
    background: #c82333;
}

.code-viewer-body {
    flex: 1;
    overflow: auto;
    background: #1e1e1e;
}

.code-table {
    border-collapse: collapse;
    width: 100%;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.5;
}

.code-table tr {
    background: #1e1e1e;
}

.code-table tr.highlighted-line {
    background: #3a3a00 !important;
}

.code-table tr.highlighted-line .line-num {
    background: #5a5a00;
    color: #fff;
}

.line-num {
    text-align: right;
    padding: 0 12px;
    color: #606060;
    background: #252526;
    user-select: none;
    min-width: 50px;
    border-right: 1px solid #333;
    vertical-align: top;
}

.line-code {
    padding: 0 16px;
    white-space: pre;
    color: #d4d4d4;
}

.line-code pre {
    margin: 0;
    padding: 0;
}

.line-code code {
    font-family: inherit;
    background: transparent !important;
    padding: 0 !important;
}

.code-viewer-body .loading {
    color: #888;
    padding: 20px;
    text-align: center;
}

.code-viewer-body .error {
    color: #ff6b6b;
    padding: 20px;
    text-align: center;
}

/* Markdown rendering in code viewer */
.code-viewer-body.markdown-mode {
    background: #ffffff;
}

.markdown-viewer {
    padding: 20px 30px;
    color: #333;
    max-width: 900px;
    margin: 0 auto;
}

.markdown-viewer h1 {
    font-size: 24px;
    border-bottom: 2px solid #0066cc;
    padding-bottom: 8px;
    margin-top: 30px;
}

.markdown-viewer h2 {
    font-size: 20px;
    margin-top: 25px;
    color: #2c3e50;
}

.markdown-viewer h3 {
    font-size: 16px;
    margin-top: 20px;
    color: #34495e;
}

.markdown-viewer p {
    margin: 12px 0;
    line-height: 1.7;
}

.markdown-viewer ul, .markdown-viewer ol {
    margin: 12px 0;
    padding-left: 25px;
}

.markdown-viewer li {
    margin: 6px 0;
    line-height: 1.6;
}

.markdown-viewer code {
    background: #f4f4f4;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 13px;
}

.markdown-viewer pre {
    background: #2d2d2d;
    color: #ccc;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 15px 0;
}

.markdown-viewer pre code {
    background: none;
    padding: 0;
    color: inherit;
}

.markdown-viewer blockquote {
    margin: 15px 0;
    padding: 10px 15px;
    border-left: 4px solid #0066cc;
    background: #f8f9fa;
    color: #555;
}

.markdown-viewer table {
    border-collapse: collapse;
    margin: 15px 0;
    width: 100%;
}

.markdown-viewer th, .markdown-viewer td {
    border: 1px solid #dee2e6;
    padding: 8px 12px;
    text-align: left;
}

.markdown-viewer th {
    background: #f8f9fa;
    font-weight: 600;
}

.markdown-viewer strong {
    font-weight: 600;
}

.markdown-viewer a {
    color: #0066cc;
}

.markdown-viewer hr {
    border: none;
    border-top: 1px solid #dee2e6;
    margin: 20px 0;
}

.markdown-viewer .highlight-target {
    background: #fff3cd;
    animation: highlight-fade 2s ease-out;
}

@keyframes highlight-fade {
    0% { background: #fff3cd; }
    100% { background: transparent; }
}

/* ==========================================================================
   Legend Modal (REQ-tv-d00002-B: _generate_legend_modal_css)
   ========================================================================== */

.legend-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.legend-modal.hidden {
    display: none;
}

.legend-modal-container {
    background: white;
    border-radius: 8px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.legend-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
}

.legend-modal-header h2 {
    margin: 0;
    font-size: 16px;
}

.legend-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 0 5px;
}

.legend-modal-close:hover {
    color: #000;
}

.legend-modal-body {
    padding: 20px;
}

.legend-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.legend-section h3 {
    font-size: 13px;
    margin: 0 0 10px 0;
    color: #495057;
}

.legend-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 12px;
}

.legend-section li {
    margin: 6px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ==========================================================================
   File Picker Modal (REQ-tv-d00002-B: _generate_file_picker_modal_css)
   ========================================================================== */

.file-picker-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.file-picker-modal.hidden {
    display: none;
}

.file-picker-container {
    background: white;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.file-picker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
}

.file-picker-header h2 {
    margin: 0;
    font-size: 18px;
}

.file-picker-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 0 5px;
}

.file-picker-close:hover {
    color: #333;
}

.file-picker-body {
    padding: 20px;
    overflow-y: auto;
}

.file-picker-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.file-picker-input-row input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.file-picker-input-row input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.file-picker-error {
    color: #dc3545;
    font-size: 12px;
    margin-bottom: 10px;
    padding: 5px 10px;
    background: #fff5f5;
    border-radius: 3px;
}

.file-picker-hint {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

.file-picker-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.file-picker-item {
    padding: 8px 12px;
    cursor: pointer;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 13px;
    border-bottom: 1px solid #eee;
}

.file-picker-item:last-child {
    border-bottom: none;
}

.file-picker-item:hover {
    background: #e3f2fd;
}

.file-picker-empty {
    padding: 15px;
    color: #666;
    text-align: center;
    font-style: italic;
}

/* ==========================================================================
   Toast Notifications
   ========================================================================== */

.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    padding: 12px 20px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    font-size: 14px;
    max-width: 350px;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.toast.show {
    opacity: 1;
    transform: translateX(0);
}

.toast-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.toast-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.toast-warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}

.toast-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

/* ==========================================================================
   Moved Indicator
   ========================================================================== */

.moved-indicator {
    display: inline-block;
    margin-left: 4px;
    cursor: help;
    font-size: 12px;
}

/* Style requirement nodes that have been moved */
.req-node.moved .req-label {
    font-style: italic;
}

.req-node.moved::after {
    content: ' (moved)';
    font-size: 10px;
    color: #6c757d;
    font-style: italic;
}

/* Moved file info in Requirements panel */
.req-card-file.file-moved {
    color: #28a745;
}

.moved-from {
    font-size: 11px;
    color: #6c757d;
    font-style: italic;
}

    </style>


</head>
<body class="">
<div class="app-layout">
    <div class="main-content">
        <div class="container">
            <div class="title-bar">
                <h1>Requirements Traceability</h1>
                <div class="stats-badges">
                    <span class="stat-badge prd" id="badgePRD"
                          data-active="3"
                          data-all="3"
                          onclick="filterByLevel('PRD')"
                          title="Click to filter by PRD">PRD: 3</span>
                    <span class="stat-badge ops" id="badgeOPS"
                          data-active="2"
                          data-all="2"
                          onclick="filterByLevel('OPS')"
                          title="Click to filter by OPS">OPS: 2</span>
                    <span class="stat-badge dev" id="badgeDEV"
                          data-active="3"
                          data-all="3"
                          onclick="filterByLevel('DEV')"
                          title="Click to filter by DEV">DEV: 3</span>
                    <span class="stat-badge-separator">|</span>
                    <span class="stat-badge repo-badge" id="badgeRepoCORE"
                          data-repo="CORE"
                          data-active="8"
                          data-all="8"
                          onclick="toggleRepoFilter('CORE')"
                          title="Click to toggle CORE requirements">CORE: 8</span>
                    <span class="stat-badge-separator">|</span>
                    <span class="stat-badge files-badge" id="badgeFiles"
                          data-count="0"
                          onclick="toggleFilesFilter()"
                          title="Click to toggle implementation files">Files: 0</span>
                </div>
                <span class="version-badge">v17</span>
                <button class="btn btn-legend" onclick="openLegendModal()"
                        title="Generated: 2026-01-21 19:22">‚ÑπÔ∏è Legend</button>
                <div class="mode-toggle-group">
                </div>
            </div>

            <div class="filter-controls">
                <div class="view-toggle">
                    <button class="btn view-btn active" id="btnFlatView" onclick="switchView('flat')">Flat View</button>
                    <button class="btn view-btn" id="btnHierarchyView" onclick="switchView('hierarchy')">Hierarchical View</button>
                    <button class="btn view-btn" id="btnUncommittedView" onclick="switchView('uncommitted')">Uncommitted</button>
                    <button class="btn view-btn" id="btnBranchView" onclick="switchView('branch')">Changed vs Main</button>
                </div>
                <button class="btn toggle-btn" id="btnLeafOnly" onclick="toggleLeafOnly()">üçÉ Leaf Only</button>
                <label class="checkbox-label" title="Include deprecated requirements in counts and views">
                    <input type="checkbox" id="chkIncludeDeprecated" onchange="toggleIncludeDeprecated()">
                    Include deprecated
                </label>
                <label class="checkbox-label" title="Include requirements from spec/roadmap/ directory">
                    <input type="checkbox" id="chkIncludeRoadmap" onchange="toggleIncludeRoadmap()">
                    Include roadmap
                </label>
                <button class="btn btn-secondary" id="btnExpandAll" onclick="expandAll()">‚ñº Expand All</button>
                <button class="btn btn-secondary" id="btnCollapseAll" onclick="collapseAll()">‚ñ∂ Collapse All</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                <span class="filter-stats" id="filterStats"></span>
            </div>


            <h2 id="treeTitle">Traceability Tree - Flat View</h2>

            <div class="filter-header">
                <div class="filter-column">
                    <div class="filter-label">REQ ID</div>
                    <input type="text" id="filterReqId" placeholder="Filter..." oninput="applyFilters()">
                </div>
                <div class="filter-column">
                    <div class="filter-label">Title</div>
                    <input type="text" id="filterTitle" placeholder="Search title..." oninput="applyFilters()">
                </div>
                <div class="filter-column">
                    <div class="filter-label">Level</div>
                    <select id="filterLevel" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="PRD">PRD</option>
                        <option value="OPS">OPS</option>
                        <option value="DEV">DEV</option>
                    </select>
                </div>
                <div class="filter-column">
                    <div class="filter-label">Status</div>
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="Active">Active</option>
                        <option value="Draft">Draft</option>
                        <option value="Deprecated">Deprecated</option>
                    </select>
                </div>
                <div class="filter-column">
                    <div class="filter-label">Cov</div>
                    <select id="filterCoverage" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="full">‚óè</option>
                        <option value="partial">‚óê</option>
                        <option value="none">‚óã</option>
                    </select>
                </div>
                <div class="filter-column">
                    <div class="filter-label">Topic</div>
                    <select id="filterTopic" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="core">core</option>
                        <option value="deploy">deploy</option>
                        <option value="impl">impl</option>
                    </select>
                </div>
            </div>

            <div class="req-tree" id="reqTree">
                
        <div class="req-item prd  " data-req-id="p00001" data-instance-id="inst_0" data-level="PRD" data-indent="0" data-parent-instance-id="" data-topic="core" data-status="Active" data-title="user authentication" data-file="prd-core.md" data-repo="CORE" data-is-root="true" data-uncommitted="false" data-branch-changed="false" data-has-children="true" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon">‚ñº</span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/prd-core.md#REQ-p00001" style="color: inherit; text-decoration: none;">p00001</a></div>
                    <div class="req-header">User Authentication</div>
                    <div class="req-level">PRD</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/prd-core.md#L7" style="color: inherit; text-decoration: none;">prd-core</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item dev  " data-req-id="d00001" data-instance-id="inst_1" data-level="DEV" data-indent="1" data-parent-instance-id="inst_0" data-topic="impl" data-status="Active" data-title="authentication module" data-file="dev-impl.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="false" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon"></span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#REQ-d00001" style="color: inherit; text-decoration: none;">d00001</a></div>
                    <div class="req-header">Authentication Module</div>
                    <div class="req-level">DEV</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#L7" style="color: inherit; text-decoration: none;">dev-impl</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item ops  " data-req-id="o00001" data-instance-id="inst_2" data-level="OPS" data-indent="1" data-parent-instance-id="inst_0" data-topic="deploy" data-status="Active" data-title="production deployment" data-file="ops-deploy.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="true" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon">‚ñº</span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/ops-deploy.md#REQ-o00001" style="color: inherit; text-decoration: none;">o00001</a></div>
                    <div class="req-header">Production Deployment</div>
                    <div class="req-level">OPS</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/ops-deploy.md#L7" style="color: inherit; text-decoration: none;">ops-deploy</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item dev  " data-req-id="d00001" data-instance-id="inst_3" data-level="DEV" data-indent="2" data-parent-instance-id="inst_2" data-topic="impl" data-status="Active" data-title="authentication module" data-file="dev-impl.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="false" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon"></span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#REQ-d00001" style="color: inherit; text-decoration: none;">d00001</a></div>
                    <div class="req-header">Authentication Module</div>
                    <div class="req-level">DEV</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#L7" style="color: inherit; text-decoration: none;">dev-impl</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item prd  " data-req-id="p00003" data-instance-id="inst_4" data-level="PRD" data-indent="1" data-parent-instance-id="inst_0" data-topic="core" data-status="Active" data-title="audit logging" data-file="prd-core.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="true" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon">‚ñº</span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/prd-core.md#REQ-p00003" style="color: inherit; text-decoration: none;">p00003</a></div>
                    <div class="req-header">Audit Logging</div>
                    <div class="req-level">PRD</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/prd-core.md#L41" style="color: inherit; text-decoration: none;">prd-core</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item dev  " data-req-id="d00003" data-instance-id="inst_5" data-level="DEV" data-indent="2" data-parent-instance-id="inst_4" data-topic="impl" data-status="Active" data-title="audit trail implementation" data-file="dev-impl.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="false" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon"></span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#REQ-d00003" style="color: inherit; text-decoration: none;">d00003</a></div>
                    <div class="req-header">Audit Trail Implementation</div>
                    <div class="req-level">DEV</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#L41" style="color: inherit; text-decoration: none;">dev-impl</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item prd  " data-req-id="p00002" data-instance-id="inst_6" data-level="PRD" data-indent="0" data-parent-instance-id="" data-topic="core" data-status="Active" data-title="data privacy" data-file="prd-core.md" data-repo="CORE" data-is-root="true" data-uncommitted="false" data-branch-changed="false" data-has-children="true" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon">‚ñº</span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/prd-core.md#REQ-p00002" style="color: inherit; text-decoration: none;">p00002</a></div>
                    <div class="req-header">Data Privacy</div>
                    <div class="req-level">PRD</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/prd-core.md#L24" style="color: inherit; text-decoration: none;">prd-core</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item dev  " data-req-id="d00002" data-instance-id="inst_7" data-level="DEV" data-indent="1" data-parent-instance-id="inst_6" data-topic="impl" data-status="Active" data-title="privacy controls" data-file="dev-impl.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="false" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon"></span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#REQ-d00002" style="color: inherit; text-decoration: none;">d00002</a></div>
                    <div class="req-header">Privacy Controls</div>
                    <div class="req-level">DEV</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#L24" style="color: inherit; text-decoration: none;">dev-impl</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item ops  " data-req-id="o00001" data-instance-id="inst_8" data-level="OPS" data-indent="1" data-parent-instance-id="inst_6" data-topic="deploy" data-status="Active" data-title="production deployment" data-file="ops-deploy.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="true" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon">‚ñº</span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/ops-deploy.md#REQ-o00001" style="color: inherit; text-decoration: none;">o00001</a></div>
                    <div class="req-header">Production Deployment</div>
                    <div class="req-level">OPS</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/ops-deploy.md#L7" style="color: inherit; text-decoration: none;">ops-deploy</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item dev  " data-req-id="d00001" data-instance-id="inst_9" data-level="DEV" data-indent="2" data-parent-instance-id="inst_8" data-topic="impl" data-status="Active" data-title="authentication module" data-file="dev-impl.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="false" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon"></span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#REQ-d00001" style="color: inherit; text-decoration: none;">d00001</a></div>
                    <div class="req-header">Authentication Module</div>
                    <div class="req-level">DEV</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#L7" style="color: inherit; text-decoration: none;">dev-impl</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item ops  " data-req-id="o00002" data-instance-id="inst_10" data-level="OPS" data-indent="1" data-parent-instance-id="inst_6" data-topic="deploy" data-status="Active" data-title="backup strategy" data-file="ops-deploy.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="true" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon">‚ñº</span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/ops-deploy.md#REQ-o00002" style="color: inherit; text-decoration: none;">o00002</a></div>
                    <div class="req-header">Backup Strategy</div>
                    <div class="req-level">OPS</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/ops-deploy.md#L24" style="color: inherit; text-decoration: none;">ops-deploy</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item dev  " data-req-id="d00002" data-instance-id="inst_11" data-level="DEV" data-indent="2" data-parent-instance-id="inst_10" data-topic="impl" data-status="Active" data-title="privacy controls" data-file="dev-impl.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="false" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon"></span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#REQ-d00002" style="color: inherit; text-decoration: none;">d00002</a></div>
                    <div class="req-header">Privacy Controls</div>
                    <div class="req-level">DEV</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#L24" style="color: inherit; text-decoration: none;">dev-impl</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item prd  " data-req-id="p00003" data-instance-id="inst_12" data-level="PRD" data-indent="1" data-parent-instance-id="inst_6" data-topic="core" data-status="Active" data-title="audit logging" data-file="prd-core.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="true" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon">‚ñº</span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/prd-core.md#REQ-p00003" style="color: inherit; text-decoration: none;">p00003</a></div>
                    <div class="req-header">Audit Logging</div>
                    <div class="req-level">PRD</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/prd-core.md#L41" style="color: inherit; text-decoration: none;">prd-core</a></div>
                    
                </div>
            </div>
        </div>


        <div class="req-item dev  " data-req-id="d00003" data-instance-id="inst_13" data-level="DEV" data-indent="2" data-parent-instance-id="inst_12" data-topic="impl" data-status="Active" data-title="audit trail implementation" data-file="dev-impl.md" data-repo="CORE" data-is-root="false" data-uncommitted="false" data-branch-changed="false" data-has-children="false" data-test-status="not-tested" data-coverage="none" data-roadmap="false" data-conflict="false" data-cycle="false">
            <div class="req-header-container" onclick="toggleRequirement(this)">
                <span class="collapse-icon"></span>
                <div class="req-content">
                    <div class="req-id"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#REQ-d00003" style="color: inherit; text-decoration: none;">d00003</a></div>
                    <div class="req-header">Audit Trail Implementation</div>
                    <div class="req-level">DEV</div>
                    <div class="req-badges">
                        <span class="status-badge status-active">Active</span><span class="status-suffix " title=""></span>
                    </div>
                    <div class="req-coverage" title="Unimplemented">‚óã</div>
                    <div class="req-status"><span class="test-badge test-not-tested" title="No tests implemented">‚ö°</span></div>
                    <div class="req-location"><a href="file:///home/metagamer/elspais-worktrees/final-viewtrace-port/tests/fixtures/hht-like/spec/dev-impl.md#L41" style="color: inherit; text-decoration: none;">dev-impl</a></div>
                    
                </div>
            </div>
        </div>

            </div>
        </div>
    </div>


</div>



<script>
    /**
 * TraceView Interactive Traceability Matrix JavaScript
 *
 * This module provides all interactive functionality for the trace-view HTML report.
 * Organized using the module pattern with logical sub-objects for maintainability.
 *
 * IMPLEMENTS REQUIREMENTS:
 *   REQ-tv-d00003: JavaScript Extraction
 */

const TraceView = (function() {
    'use strict';

    // ==========================================================================
    // State Management (REQ-tv-d00003-I: Global state encapsulated)
    // ==========================================================================

    /**
     * Internal state object - encapsulates all global state variables
     */
    const state = {
        reqCardStack: [],
        pendingMoves: [],
        movedRequirements: new Map(),  // Track moved reqs: reqId -> {from, to}
        editModeActive: false,
        leafOnlyActive: false,
        pendingMovesCollapsed: false,
        filePickerState: { reqId: null, sourceFile: null },
        allSpecFiles: [],
        userAddedFiles: new Set(),
        originalStatusSuffixes: new Map(),
        // Navigation state
        collapsedInstances: new Set(),
        currentView: 'flat',
        // Review mode state
        reviewModeActive: false
    };

    // ==========================================================================
    // Helper Functions
    // ==========================================================================

    /**
     * Escape HTML special characters
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Show a toast notification
     * @param {string} message - Message to display
     * @param {string} type - Type: 'success', 'error', 'warning', 'info'
     */
    function showToast(message, type = 'info') {
        // Create toast container if it doesn't exist
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container';
            document.body.appendChild(container);
        }

        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;

        // Add to container
        container.appendChild(toast);

        // Trigger animation
        requestAnimationFrame(() => {
            toast.classList.add('show');
        });

        // Auto-remove after 4 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    /**
     * Render markdown body with line numbers (table-based layout for alignment)
     * Line numbers are file-relative (starting from req.line)
     * @param {string} body - Markdown body text
     * @param {number} startLine - Starting line number in source file
     * @returns {string} HTML with line numbers
     */
    function renderMarkdownWithLines(body, startLine) {
        const lines = body.split('\n');
        const tableRowsHtml = lines.map((line, i) => {
            const lineNum = startLine + i;
            // Render each line as markdown (basic inline formatting)
            let content = escapeHtml(line);
            // Apply basic markdown formatting
            content = content
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')  // Bold
                .replace(/\*(.+?)\*/g, '<em>$1</em>')              // Italic
                .replace(/`([^`]+)`/g, '<code>$1</code>')          // Inline code
                .replace(/^(#{1,6})\s+(.+)$/, (m, h, t) =>         // Headers
                    `<span class="md-heading md-h${h.length}">${t}</span>`)
                .replace(/^[-*+]\s+(.+)$/, '<span class="md-list-item">‚Ä¢ $1</span>')  // Bullet list items
                .replace(/^\d+\.\s+(.+)$/, '<span class="md-list-item">$1</span>')    // Numbered list (1. 2. 3.)
                .replace(/^([A-Za-z])\.\s+(.+)$/, '<span class="md-list-item">$1. $2</span>');  // Lettered list (A. B. C.)

            return `<div class="rs-line-row" data-line="${lineNum}">
                <span class="rs-line-number">${lineNum}</span>
                <span class="rs-line-text">${content || ' '}</span>
            </div>`;
        }).join('');

        return `<div class="rs-lines-table">${tableRowsHtml}</div>`;
    }

    // ==========================================================================
    // Panel Management (REQ-tv-d00003-F: Logical sub-objects)
    // ==========================================================================

    /**
     * Side panel operations for requirement details
     */
    const panel = {
        /**
         * Open a requirement in the side panel
         * @param {string} reqId - The requirement ID to display
         */
        open: function(reqId) {
            const panelEl = document.getElementById('req-panel');
            const cardStack = document.getElementById('req-card-stack');
            const reqData = window.REQ_CONTENT_DATA;

            if (!reqData || !reqData[reqId]) {
                console.error('Requirement data not found:', reqId);
                return;
            }

            // Show panel if hidden
            panelEl.classList.remove('hidden');

            // Check if card already exists - if so, move it to top
            if (state.reqCardStack.includes(reqId)) {
                // Remove existing card and re-add at top
                const existingCard = document.getElementById(`req-card-${reqId}`);
                if (existingCard) {
                    existingCard.remove();
                }
                const index = state.reqCardStack.indexOf(reqId);
                if (index > -1) {
                    state.reqCardStack.splice(index, 1);
                }
                // Continue to create new card at top
            }

            // Add to stack
            state.reqCardStack.unshift(reqId);

            // Create card element
            const req = reqData[reqId];
            const card = document.createElement('div');
            card.className = 'req-card';
            card.id = `req-card-${reqId}`;

            // Render markdown content with line numbers
            // Line numbers are file-relative (starting from req.line)
            const bodyHtml = renderMarkdownWithLines(req.body, req.line);
            // Rationale starts after body - calculate line offset
            const rationaleStartLine = req.line + req.body.split('\n').length + 2; // +2 for "Rationale:" header
            const rationaleHtml = req.rationale
                ? renderMarkdownWithLines(req.rationale, rationaleStartLine)
                : '';

            // Build implements links
            let implementsHtml = '';
            if (req.implements && req.implements.length > 0) {
                const implLinks = req.implements.sort().map(parentId =>
                    `<a href="#" onclick="TraceView.panel.open('${parentId}'); return false;" class="implements-link">${parentId}</a>`
                ).join(', ');
                implementsHtml = `<div class="req-card-implements">Implements: ${implLinks}</div>`;
            }

            // Determine if in roadmap based on file path
            const isInRoadmap = req.filePath.includes('roadmap/');
            const moveButtons = isInRoadmap
                ? `<button class="edit-btn from-roadmap panel-edit-btn" onclick="TraceView.editMode.addMove('${reqId}', '${req.file}', 'from-roadmap')" title="Move out of roadmap">‚Ü© From Roadmap</button>
                   <button class="edit-btn move-file panel-edit-btn" onclick="TraceView.filePicker.show('${reqId}', '${req.file}')" title="Move to different file">üìÅ Move</button>`
                : `<button class="edit-btn to-roadmap panel-edit-btn" onclick="TraceView.editMode.addMove('${reqId}', '${req.file}', 'to-roadmap')" title="Move to roadmap">üó∫Ô∏è To Roadmap</button>
                   <button class="edit-btn move-file panel-edit-btn" onclick="TraceView.filePicker.show('${reqId}', '${req.file}')" title="Move to different file">üìÅ Move</button>`;

            // Generate VS Code link - use relative path when REPO_ROOT is empty (portable mode)
            // Strip ALL leading ../ components to get path relative to repo root
            const repoRelPath = req.filePath.replace(/^(\.\.\/)+/, '');
            const vscodeHref = window.REPO_ROOT
                ? `vscode://file/${window.REPO_ROOT}/${repoRelPath}:${req.line}`
                : `${req.filePath}`;  // Relative link for portable mode
            const vscodeTitle = window.REPO_ROOT
                ? 'Open in VS Code'
                : `Open file (${repoRelPath}:${req.line})`;

            card.innerHTML = `
                <div class="req-card-header">
                    <span class="req-card-title">REQ-${reqId}: ${req.title}</span>
                    <button class="close-btn" onclick="TraceView.panel.close('${reqId}')">√ó</button>
                </div>
                <div class="req-card-body">
                    <div class="req-card-meta">
                        <span class="badge">${req.level}</span>
                        <span class="badge">${req.status}</span>
                        <a href="#" onclick="TraceView.codeViewer.open('${req.filePath}', ${req.line}); return false;" class="file-ref-link">${req.file}:${req.line}</a>
                        <a href="${vscodeHref}" title="${vscodeTitle}" class="vscode-link">üîß</a>
                    </div>
                    <div class="req-card-actions edit-actions">
                        ${moveButtons}
                    </div>
                    ${implementsHtml}
                    <div class="req-card-content rs-lined-content">
                        <div class="req-body-section">
                            <h5 class="rs-section-label">Body</h5>
                            ${bodyHtml}
                        </div>
                        ${rationaleHtml ? `
                        <div class="req-rationale-section">
                            <h5 class="rs-section-label">Rationale</h5>
                            ${rationaleHtml}
                        </div>` : ''}
                    </div>
                </div>
            `;

            // Add to top of stack
            cardStack.insertBefore(card, cardStack.firstChild);

            // Add click handler to update Review Panel when card is clicked
            card.addEventListener('click', function(e) {
                // Don't trigger if clicking on buttons, links, or inputs
                if (e.target.closest('button, a, input, textarea')) return;

                const reviewActive = (window.ReviewSystem && window.ReviewSystem.isReviewModeActive && window.ReviewSystem.isReviewModeActive()) ||
                                     state.reviewModeActive;
                if (reviewActive) {
                    document.dispatchEvent(new CustomEvent('traceview:req-selected', {
                        detail: { reqId: reqId, req: req }
                    }));
                }
            });

            // Notify review system if in review mode (initial open)
            // Check ReviewSystem.isReviewModeActive() directly since it's the source of truth
            const reviewActive = (window.ReviewSystem && window.ReviewSystem.isReviewModeActive && window.ReviewSystem.isReviewModeActive()) ||
                                 state.reviewModeActive;
            if (reviewActive) {
                // Apply interactive line numbers with click handlers (REQ-d00092)
                if (window.ReviewSystem && window.ReviewSystem.applyLineNumbersToCard) {
                    window.ReviewSystem.applyLineNumbersToCard(card, reqId);
                } else if (window.TraceView && window.TraceView.review && window.TraceView.review.applyLineNumbersToCard) {
                    window.TraceView.review.applyLineNumbersToCard(card, reqId);
                }

                document.dispatchEvent(new CustomEvent('traceview:req-selected', {
                    detail: { reqId: reqId, req: req }
                }));
            }
        },

        /**
         * Close a specific requirement card
         * @param {string} reqId - The requirement ID to close
         */
        close: function(reqId) {
            const card = document.getElementById(`req-card-${reqId}`);
            if (card) {
                card.remove();
            }
            const index = state.reqCardStack.indexOf(reqId);
            if (index > -1) {
                state.reqCardStack.splice(index, 1);
            }

            // Hide panel if empty
            if (state.reqCardStack.length === 0) {
                document.getElementById('req-panel').classList.add('hidden');
            }
        },

        /**
         * Close all requirement cards
         */
        closeAll: function() {
            const cardStack = document.getElementById('req-card-stack');
            cardStack.innerHTML = '';
            state.reqCardStack.length = 0;
            document.getElementById('req-panel').classList.add('hidden');
        },

        /**
         * Initialize panel resize functionality
         */
        initResize: function() {
            const panelEl = document.getElementById('req-panel');
            const handle = document.getElementById('resizeHandle');
            if (!panelEl || !handle) return;

            let isResizing = false;
            let startX, startWidth;

            handle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = panelEl.offsetWidth;
                handle.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                const diff = startX - e.clientX;
                const newWidth = Math.min(Math.max(startWidth + diff, 250), window.innerWidth * 0.7);
                panelEl.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    handle.classList.remove('dragging');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }
    };

    // ==========================================================================
    // Code Viewer (REQ-tv-d00003-F: Logical sub-objects)
    // ==========================================================================

    /**
     * Code viewer modal operations
     */
    const codeViewer = {
        /**
         * Get language class for syntax highlighting
         * @param {string} ext - File extension
         * @returns {string} Language class for highlight.js
         */
        getLangClass: function(ext) {
            const langMap = {
                'dart': 'language-dart',
                'sql': 'language-sql',
                'py': 'language-python',
                'js': 'language-javascript',
                'ts': 'language-typescript',
                'json': 'language-json',
                'md': 'language-markdown',
                'yaml': 'language-yaml',
                'yml': 'language-yaml',
                'sh': 'language-bash',
                'bash': 'language-bash'
            };
            return langMap[ext] || 'language-plaintext';
        },

        /**
         * Open the code viewer modal with file content
         * @param {string} filePath - Path to the file
         * @param {number} lineNum - Line number to highlight
         */
        open: async function(filePath, lineNum) {
            const modal = document.getElementById('code-viewer-modal');
            const content = document.getElementById('code-viewer-content');
            const title = document.getElementById('code-viewer-title');
            const lineInfo = document.getElementById('code-viewer-line');
            const vscodeLink = document.getElementById('code-viewer-vscode');

            title.textContent = filePath;
            lineInfo.textContent = `Line ${lineNum}`;
            content.innerHTML = '<div class="loading">Loading...</div>';
            modal.classList.remove('hidden');

            // Set VS Code link
            if (vscodeLink) {
                // Strip ALL leading ../ components to get path relative to repo root
                const repoRelPath = filePath.replace(/^(\.\.\/)+/, '');
                if (window.REPO_ROOT) {
                    const absPath = window.REPO_ROOT + '/' + repoRelPath;
                    vscodeLink.href = `vscode://file/${absPath}:${lineNum}`;
                    vscodeLink.title = 'Open in VS Code';
                } else {
                    vscodeLink.href = filePath;
                    vscodeLink.title = `Open file (${repoRelPath}:${lineNum})`;
                }
            }

            try {
                // Handle file:// URLs by using the server API (browsers block file:// fetches)
                let fetchUrl = filePath;
                if (filePath.startsWith('file://')) {
                    const absPath = filePath.replace('file://', '');
                    fetchUrl = `/api/files?path=${encodeURIComponent(absPath)}`;
                }
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text = await response.text();
                const ext = filePath.split('.').pop().toLowerCase();

                // For markdown files, render as formatted markdown
                if (ext === 'md' && window.marked) {
                    // Pre-process: convert lettered lists (A. B. C.) to proper markdown lists
                    // Standard markdown only recognizes numbered (1. 2.) and bullet (- *) lists
                    const processedText = this._preprocessMarkdown(text);
                    const renderedHtml = marked.parse(processedText);
                    content.innerHTML = `<div class="markdown-viewer markdown-body">${renderedHtml}</div>`;
                    content.classList.add('markdown-mode');
                    this._scrollToMarkdownLine(content, text, lineNum);
                } else {
                    // For code files, show with line numbers
                    content.classList.remove('markdown-mode');
                    this._renderCodeWithLines(content, text, lineNum, ext);
                }
            } catch (err) {
                content.innerHTML = `<div class="error">Failed to load file: ${err.message}</div>`;
            }
        },

        /**
         * Render code with line numbers and highlighting
         * @private
         */
        _renderCodeWithLines: function(content, text, lineNum, ext) {
            const lines = text.split('\n');
            const langClass = this.getLangClass(ext);

            let html = '<table class="code-table"><tbody>';
            lines.forEach((line, idx) => {
                const lineNumber = idx + 1;
                const isHighlighted = lineNumber === lineNum;
                const highlightClass = isHighlighted ? 'highlighted-line' : '';
                const lineId = `L${lineNumber}`;
                const escapedLine = line
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                html += `<tr id="${lineId}" class="${highlightClass}">`;
                html += `<td class="line-num">${lineNumber}</td>`;
                html += `<td class="line-code"><pre><code class="${langClass}">${escapedLine || ' '}</code></pre></td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';

            content.innerHTML = html;

            // Scroll to highlighted line
            setTimeout(() => {
                const highlightedRow = content.querySelector('.highlighted-line');
                if (highlightedRow) {
                    highlightedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);

            // Apply syntax highlighting if hljs is available
            if (window.hljs) {
                content.querySelectorAll('code').forEach(block => {
                    hljs.highlightElement(block);
                });
            }
        },

        /**
         * Scroll to approximate line in markdown view
         * @private
         */
        _scrollToMarkdownLine: function(content, text, lineNum) {
            const lines = text.split('\n');
            setTimeout(() => {
                let targetElement = null;

                // Find the nearest heading at or before the target line
                const headings = content.querySelectorAll('h1, h2, h3, h4');
                for (const heading of headings) {
                    const headingText = heading.textContent.trim();
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('#') && line.includes(headingText)) {
                            if (i + 1 <= lineNum) {
                                targetElement = heading;
                            }
                            break;
                        }
                    }
                }

                // Fallback to first heading
                if (!targetElement) {
                    targetElement = content.querySelector('h1, h2, h3');
                }

                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    targetElement.classList.add('highlight-target');
                    setTimeout(() => targetElement.classList.remove('highlight-target'), 2000);
                }
            }, 100);
        },

        /**
         * Pre-process markdown to handle non-standard list formats
         * Converts lettered lists (A. B. C.) to standard bullet lists
         * @private
         */
        _preprocessMarkdown: function(text) {
            const lines = text.split('\n');
            const result = [];

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                // Match lines starting with a single uppercase letter followed by period and space
                // e.g., "A. The system SHALL..." -> "- **A.** The system SHALL..."
                const letteredMatch = line.match(/^([A-Z])\.\s+(.+)$/);
                if (letteredMatch) {
                    // Convert to bullet list with bold letter prefix
                    line = `- **${letteredMatch[1]}.** ${letteredMatch[2]}`;
                }
                result.push(line);
            }

            return result.join('\n');
        },

        /**
         * Close the code viewer modal
         */
        close: function() {
            document.getElementById('code-viewer-modal').classList.add('hidden');
        }
    };

    // ==========================================================================
    // Edit Mode (REQ-tv-d00003-F: Logical sub-objects)
    // ==========================================================================

    /**
     * Edit mode operations for batch requirement moves
     */
    const editMode = {
        /**
         * Toggle edit mode on/off
         */
        toggle: function() {
            state.editModeActive = !state.editModeActive;
            const btn = document.getElementById('btnEditMode');
            const panel = document.getElementById('editModePanel');

            if (state.editModeActive) {
                document.body.classList.add('edit-mode-active');
                btn.classList.add('active');
                panel.style.display = 'block';
                document.getElementById('chkIncludeRoadmap').checked = true;
                applyFilters();
            } else {
                document.body.classList.remove('edit-mode-active');
                btn.classList.remove('active');
                panel.style.display = 'none';
            }
        },

        /**
         * Add a pending move operation
         * @param {string} reqId - Requirement ID
         * @param {string} sourceFile - Source file path
         * @param {string} moveType - Type of move ('to-roadmap', 'from-roadmap', 'move-file')
         */
        addMove: function(reqId, sourceFile, moveType) {
            const existing = state.pendingMoves.find(m => m.reqId === reqId);
            if (existing) {
                alert('This requirement already has a pending move. Clear selection first.');
                return;
            }

            const reqItem = document.querySelector(`.req-item[data-req-id="${reqId}"]`);
            const title = reqItem ? reqItem.dataset.title : '';

            const move = {
                reqId: reqId,
                sourceFile: sourceFile,
                moveType: moveType,
                title: title,
                targetFile: moveType === 'to-roadmap' ? `roadmap/${sourceFile}` :
                            moveType === 'from-roadmap' ? sourceFile.replace('roadmap/', '') :
                            null
            };
            state.pendingMoves.push(move);
            this._updateUI();
            this._updateDestinationColumns();
        },

        /**
         * Remove a pending move by index
         * @param {number} index - Index in pendingMoves array
         */
        removeMove: function(index) {
            state.pendingMoves.splice(index, 1);
            this._updateUI();
            this._updateDestinationColumns();
        },

        /**
         * Clear all pending moves
         */
        clearMoves: function() {
            state.pendingMoves.length = 0;
            this._updateUI();
            this._updateDestinationColumns();
        },

        /**
         * Apply moves via server API
         */
        applyMoves: async function() {
            if (state.pendingMoves.length === 0) {
                showToast('No pending moves to apply.', 'warning');
                return;
            }

            const moves = state.pendingMoves
                .filter(m => m.targetFile)
                .map(m => ({
                    reqId: m.reqId,
                    source: m.sourceFile,
                    target: m.targetFile
                }));

            if (moves.length === 0) {
                showToast('No valid moves (all moves need target files).', 'warning');
                return;
            }

            // Disable button during operation
            const btn = document.getElementById('btnApplyMoves');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Applying...';
            }

            try {
                const response = await fetch('/api/apply-moves', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(moves)
                });

                const result = await response.json();

                if (result.success) {
                    // Track moved requirements for visual indicator
                    moves.forEach(move => {
                        state.movedRequirements.set(move.reqId, {
                            from: move.source,
                            to: move.target
                        });
                        // Update the file in REQ_CONTENT_DATA
                        if (window.REQ_CONTENT_DATA && window.REQ_CONTENT_DATA[move.reqId]) {
                            window.REQ_CONTENT_DATA[move.reqId].file = move.target;
                        }
                    });

                    // Clear pending moves
                    this.clearMoves();

                    // Update tree to show moved indicators
                    this._updateMovedIndicators();

                    showToast(`Successfully moved ${moves.length} requirement(s)`, 'success');
                } else {
                    showToast(`Move failed: ${result.error}`, 'error');
                }
            } catch (err) {
                showToast(`Move failed: ${err.message}`, 'error');
            } finally {
                if (btn) {
                    btn.disabled = state.pendingMoves.length === 0;
                    btn.textContent = 'Apply Moves';
                }
            }
        },

        /**
         * Update tree nodes to show moved indicators
         * @private
         */
        _updateMovedIndicators: function() {
            state.movedRequirements.forEach((info, reqId) => {
                // Find tree nodes with this reqId
                const nodes = document.querySelectorAll(`[data-req-id="${reqId}"]`);
                nodes.forEach(node => {
                    // Add moved indicator if not already present
                    if (!node.querySelector('.moved-indicator')) {
                        const indicator = document.createElement('span');
                        indicator.className = 'moved-indicator';
                        indicator.textContent = ' üì¶';
                        indicator.title = `Moved from: ${info.from} ‚Üí ${info.to}`;
                        // Insert inline with REQ ID in hierarchy view
                        const reqIdEl = node.querySelector('.req-id');
                        if (reqIdEl) {
                            reqIdEl.appendChild(indicator);
                        } else {
                            // Fallback for other node types
                            node.appendChild(indicator);
                        }
                    }
                });

                // Also update the Requirements panel if this REQ is open
                const card = document.getElementById(`req-card-${reqId}`);
                if (card) {
                    this._updateCardFileInfo(card, reqId, info);
                }
            });
        },

        /**
         * Update file info in a requirement card after move
         * @private
         */
        _updateCardFileInfo: function(card, reqId, moveInfo) {
            // Find the file link in the card header
            const fileLink = card.querySelector('.req-card-file');
            if (fileLink) {
                // Update the file path display
                const oldText = fileLink.textContent;
                fileLink.innerHTML = `üì¶ ${moveInfo.to} <span class="moved-from">(was: ${moveInfo.from})</span>`;
                fileLink.classList.add('file-moved');
            }
        },

        /**
         * Toggle pending moves list visibility
         */
        togglePendingMoves: function() {
            state.pendingMovesCollapsed = !state.pendingMovesCollapsed;
            const list = document.getElementById('pendingMovesList');
            const toggleBtn = document.getElementById('pendingMovesToggle');
            if (state.pendingMovesCollapsed) {
                list.style.display = 'none';
                toggleBtn.textContent = '‚ñ∂';
            } else {
                list.style.display = 'block';
                toggleBtn.textContent = '‚ñº';
            }
        },

        /**
         * Update the pending moves UI
         * @private
         */
        _updateUI: function() {
            const list = document.getElementById('pendingMovesList');
            const count = document.getElementById('pendingChangesCount');
            const btn = document.getElementById('btnApplyMoves');

            count.textContent = state.pendingMoves.length + ' pending';
            btn.disabled = state.pendingMoves.length === 0;

            if (state.pendingMoves.length === 0) {
                list.innerHTML = '<div style="color: #666; padding: 10px;">No pending moves. Click edit buttons on requirements to select them.</div>';
                return;
            }

            list.innerHTML = state.pendingMoves.map((m, i) => {
                const displayTarget = m.targetFile ?
                    (m.moveType === 'to-roadmap' ? 'Roadmap' :
                     m.moveType === 'from-roadmap' ? m.targetFile :
                     m.targetFile) :
                    '(select target)';
                const titleDisplay = m.title ? ` - ${m.title}` : '';
                return `
                <div class="pending-move-item">
                    <span><strong>REQ-${m.reqId}</strong>${titleDisplay}</span>
                    <span style="color: #666; margin-left: 8px;">‚Üí ${displayTarget}</span>
                    <button onclick="TraceView.editMode.removeMove(${i})" style="background: none; border: none; cursor: pointer; margin-left: auto;">‚úï</button>
                </div>
            `}).join('');
        },

        /**
         * Update destination columns in the requirement tree
         * @private
         */
        _updateDestinationColumns: function() {
            // Reset all destination columns
            document.querySelectorAll('.req-destination').forEach(el => {
                const editActions = el.querySelector('.edit-actions');
                const destText = el.querySelector('.dest-text');
                if (editActions) editActions.style.display = '';
                if (destText) {
                    destText.textContent = '';
                    destText.style.display = 'none';
                }
                el.className = 'req-destination edit-mode-column';
            });

            // Restore original status suffixes for items not in pending moves
            document.querySelectorAll('.req-item[data-req-id]').forEach(item => {
                const reqId = item.dataset.reqId;
                const suffixEl = item.querySelector('.status-suffix');
                if (suffixEl && state.originalStatusSuffixes.has(reqId)) {
                    const original = state.originalStatusSuffixes.get(reqId);
                    if (!state.pendingMoves.some(m => m.reqId === reqId)) {
                        suffixEl.textContent = original.text;
                        suffixEl.className = original.className;
                        suffixEl.title = original.title;
                    }
                }
            });

            // Update destination columns and status suffixes for pending moves
            state.pendingMoves.forEach(m => {
                const reqItem = document.querySelector(`.req-item[data-req-id="${m.reqId}"]`);
                if (!reqItem) return;

                const destEl = reqItem.querySelector('.req-destination');
                const suffixEl = reqItem.querySelector('.status-suffix');

                // Save original status suffix if not already saved
                if (suffixEl && !state.originalStatusSuffixes.has(m.reqId)) {
                    state.originalStatusSuffixes.set(m.reqId, {
                        text: suffixEl.textContent,
                        className: suffixEl.className,
                        title: suffixEl.title
                    });
                }

                // Update destination column
                if (destEl) {
                    const editActions = destEl.querySelector('.edit-actions');
                    const destText = destEl.querySelector('.dest-text');

                    if (editActions) editActions.style.display = 'none';
                    if (destText) {
                        destText.style.display = '';
                        if (m.moveType === 'to-roadmap') {
                            destText.textContent = '‚Üí Roadmap';
                            destEl.className = 'req-destination edit-mode-column to-roadmap';
                        } else if (m.moveType === 'from-roadmap') {
                            destText.textContent = '‚Üê From Roadmap';
                            destEl.className = 'req-destination edit-mode-column from-roadmap';
                        } else if (m.targetFile) {
                            const displayName = m.targetFile.replace('roadmap/', '').replace(/\.md$/, '');
                            destText.textContent = '‚Üí ' + displayName;
                        }
                    }
                }

                // Update status suffix
                if (suffixEl) {
                    const originalText = state.originalStatusSuffixes.get(m.reqId)?.text || '';
                    if (originalText && originalText !== '‚Üù' && originalText !== '‚á¢') {
                        suffixEl.textContent = '‚á¢' + originalText;
                        suffixEl.className = 'status-suffix status-pending-move';
                        suffixEl.title = 'PENDING MOVE + ' + (state.originalStatusSuffixes.get(m.reqId)?.title || '');
                    } else {
                        suffixEl.textContent = '‚á¢';
                        suffixEl.className = 'status-suffix status-pending-move';
                        suffixEl.title = 'PENDING MOVE (not yet executed)';
                    }
                }
            });
        }
    };

    // ==========================================================================
    // File Picker (REQ-tv-d00003-F: Logical sub-objects)
    // ==========================================================================

    /**
     * File picker modal operations
     */
    const filePicker = {
        /**
         * Show the file picker modal
         * @param {string} reqId - Requirement ID
         * @param {string} sourceFile - Source file path
         */
        show: function(reqId, sourceFile) {
            state.filePickerState = { reqId, sourceFile };
            state.allSpecFiles = this._getAvailableFiles();

            const modal = document.getElementById('file-picker-modal');
            const input = document.getElementById('filePickerInput');
            const error = document.getElementById('filePickerError');

            input.value = '';
            error.textContent = '';
            error.style.display = 'none';

            this._renderList('');
            modal.classList.remove('hidden');
            input.focus();
        },

        /**
         * Close the file picker modal
         */
        close: function() {
            document.getElementById('file-picker-modal').classList.add('hidden');
            state.filePickerState = { reqId: null, sourceFile: null };
        },

        /**
         * Filter the file list based on input
         * @param {string} value - Filter value
         */
        filter: function(value) {
            this._renderList(value);
            this._validate(value);
        },

        /**
         * Select a file from the list
         * @param {string} filename - Selected filename
         */
        select: function(filename) {
            document.getElementById('filePickerInput').value = filename;
            this._validate(filename);
        },

        /**
         * Confirm the file picker selection
         */
        confirm: function() {
            const input = document.getElementById('filePickerInput');
            const filename = input.value.trim();

            if (!this._validate(filename)) {
                return;
            }

            state.userAddedFiles.add(filename);
            editMode.addMove(state.filePickerState.reqId, state.filePickerState.sourceFile, 'move-file');
            state.pendingMoves[state.pendingMoves.length - 1].targetFile = filename;
            editMode._updateUI();
            editMode._updateDestinationColumns();

            this.close();
        },

        /**
         * Render the file list
         * @private
         */
        _renderList: function(filter) {
            const list = document.getElementById('filePickerList');
            const filterLower = filter.toLowerCase();

            const filtered = state.allSpecFiles.filter(f =>
                f.toLowerCase().includes(filterLower)
            );

            if (filtered.length === 0 && filter) {
                list.innerHTML = '<div class="file-picker-empty">No matching files. You can enter a new filename.</div>';
            } else {
                list.innerHTML = filtered.map(f =>
                    `<div class="file-picker-item" onclick="TraceView.filePicker.select('${f}')">${f}</div>`
                ).join('');
            }
        },

        /**
         * Validate the filename
         * @private
         */
        _validate: function(filename) {
            const error = document.getElementById('filePickerError');

            if (!filename || !filename.trim()) {
                error.style.display = 'none';
                return false;
            }

            filename = filename.trim();

            if (!filename.endsWith('.md')) {
                error.textContent = 'Filename must end with .md';
                error.style.display = 'block';
                return false;
            }

            const illegalChars = /[<>:"|?*\x00-\x1f]/;
            if (illegalChars.test(filename)) {
                error.textContent = 'Filename contains illegal characters';
                error.style.display = 'block';
                return false;
            }

            if (filename.includes(' ')) {
                error.textContent = 'Use dashes instead of spaces';
                error.style.display = 'block';
                return false;
            }

            if (/^[.\-\/]/.test(filename)) {
                error.textContent = 'Filename cannot start with . - or /';
                error.style.display = 'block';
                return false;
            }

            error.style.display = 'none';
            return true;
        },

        /**
         * Get available target files
         * @private
         */
        _getAvailableFiles: function() {
            const files = new Set();
            document.querySelectorAll('.req-item[data-file]').forEach(item => {
                files.add(item.dataset.file);
            });
            state.userAddedFiles.forEach(f => files.add(f));
            return Array.from(files).sort();
        }
    };

    // ==========================================================================
    // Legend Modal
    // ==========================================================================

    /**
     * Legend modal operations
     */
    const legend = {
        /**
         * Open the legend modal
         */
        open: function() {
            document.getElementById('legend-modal').classList.remove('hidden');
        },

        /**
         * Close the legend modal
         */
        close: function() {
            document.getElementById('legend-modal').classList.add('hidden');
        }
    };

    // ==========================================================================
    // Navigation & View Management
    // ==========================================================================

    /**
     * Navigation operations for requirement tree
     */
    const navigation = {
        /**
         * Toggle a single requirement instance's children
         * @param {HTMLElement} element - The clicked element
         */
        toggleRequirement: function(element) {
            const item = element.closest('.req-item');
            const instanceId = item.dataset.instanceId;
            const icon = element.querySelector('.collapse-icon');

            if (!icon || !icon.textContent) return; // No children to collapse

            const isExpanding = state.collapsedInstances.has(instanceId);

            if (isExpanding) {
                state.collapsedInstances.delete(instanceId);
                icon.classList.remove('collapsed');
            } else {
                state.collapsedInstances.add(instanceId);
                icon.classList.add('collapsed');
            }

            if (state.currentView === 'hierarchy') {
                this.toggleRequirementHierarchy(instanceId, isExpanding);
            } else {
                if (isExpanding) {
                    this.showDescendants(instanceId);
                } else {
                    this.hideDescendants(instanceId);
                }
            }
            this.updateExpandCollapseButtons();
        },

        /**
         * Hide all descendants of a requirement instance
         * @param {string} parentInstanceId - Parent instance ID
         */
        hideDescendants: function(parentInstanceId) {
            document.querySelectorAll(`[data-parent-instance-id="${parentInstanceId}"]`).forEach(child => {
                child.classList.add('collapsed-by-parent');
                this.hideDescendants(child.dataset.instanceId);
            });
        },

        /**
         * Show immediate children of a requirement instance
         * @param {string} parentInstanceId - Parent instance ID
         */
        showDescendants: function(parentInstanceId) {
            document.querySelectorAll(`[data-parent-instance-id="${parentInstanceId}"]`).forEach(child => {
                child.classList.remove('collapsed-by-parent');
            });
        },

        /**
         * Modified toggle for hierarchy view
         * @param {string} parentInstanceId - Parent instance ID
         * @param {boolean} isExpanding - Whether expanding or collapsing
         */
        toggleRequirementHierarchy: function(parentInstanceId, isExpanding) {
            document.querySelectorAll(`[data-parent-instance-id="${parentInstanceId}"]`).forEach(child => {
                if (isExpanding) {
                    child.classList.add('hierarchy-visible');
                    child.classList.remove('collapsed-by-parent');
                } else {
                    child.classList.remove('hierarchy-visible');
                    child.classList.add('collapsed-by-parent');
                    const childIcon = child.querySelector('.collapse-icon');
                    if (childIcon && childIcon.textContent) {
                        state.collapsedInstances.add(child.dataset.instanceId);
                        childIcon.classList.add('collapsed');
                        this.toggleRequirementHierarchy(child.dataset.instanceId, false);
                    }
                }
            });
        },

        /**
         * Update expand/collapse button states
         */
        updateExpandCollapseButtons: function() {
            const btnExpand = document.getElementById('btnExpandAll');
            const btnCollapse = document.getElementById('btnCollapseAll');

            let expandableCount = 0;
            let expandedCount = 0;
            let collapsedCount = 0;

            document.querySelectorAll('.req-item:not(.filtered-out)').forEach(item => {
                const icon = item.querySelector('.collapse-icon');
                if (icon && icon.textContent) {
                    expandableCount++;
                    if (icon.classList.contains('collapsed')) {
                        collapsedCount++;
                    } else {
                        expandedCount++;
                    }
                }
            });

            if (expandableCount > 0 && expandedCount === expandableCount) {
                btnExpand.classList.add('active');
                btnExpand.textContent = '‚ñº All Expanded';
            } else {
                btnExpand.classList.remove('active');
                btnExpand.textContent = '‚ñº Expand All';
            }

            if (expandableCount > 0 && collapsedCount === expandableCount) {
                btnCollapse.classList.add('active');
                btnCollapse.textContent = '‚ñ∂ All Collapsed';
            } else {
                btnCollapse.classList.remove('active');
                btnCollapse.textContent = '‚ñ∂ Collapse All';
            }
        },

        /**
         * Expand all requirements
         */
        expandAll: function() {
            state.collapsedInstances.clear();
            const isHierarchyView = state.currentView === 'hierarchy';
            document.querySelectorAll('.req-item').forEach(item => {
                item.classList.remove('collapsed-by-parent');
                if (isHierarchyView && item.dataset.isRoot !== 'true') {
                    item.classList.add('hierarchy-visible');
                }
            });
            document.querySelectorAll('.collapse-icon').forEach(el => {
                el.classList.remove('collapsed');
            });
            this.updateExpandCollapseButtons();
        },

        /**
         * Collapse all requirements
         */
        collapseAll: function() {
            const isHierarchyView = state.currentView === 'hierarchy';
            document.querySelectorAll('.req-item').forEach(item => {
                const icon = item.querySelector('.collapse-icon');
                if (isHierarchyView && item.dataset.isRoot !== 'true') {
                    item.classList.remove('hierarchy-visible');
                    item.classList.add('collapsed-by-parent');
                }
                if (icon && icon.textContent) {
                    state.collapsedInstances.add(item.dataset.instanceId);
                    this.hideDescendants(item.dataset.instanceId);
                    icon.classList.add('collapsed');
                }
            });
            this.updateExpandCollapseButtons();
        },

        /**
         * Switch between view modes
         * @param {string} viewMode - 'flat', 'hierarchy', 'uncommitted', or 'branch'
         */
        switchView: function(viewMode) {
            state.currentView = viewMode;
            const reqTree = document.getElementById('reqTree');
            const btnFlat = document.getElementById('btnFlatView');
            const btnHierarchy = document.getElementById('btnHierarchyView');
            const btnUncommitted = document.getElementById('btnUncommittedView');
            const btnBranch = document.getElementById('btnBranchView');
            const treeTitle = document.getElementById('treeTitle');

            btnFlat.classList.remove('active');
            btnHierarchy.classList.remove('active');
            btnUncommitted.classList.remove('active');
            btnBranch.classList.remove('active');
            reqTree.classList.remove('hierarchy-view');
            reqTree.classList.remove('flat-view');

            if (viewMode === 'hierarchy') {
                reqTree.classList.add('hierarchy-view');
                btnHierarchy.classList.add('active');
                treeTitle.textContent = 'Traceability Tree - Hierarchical View';
                state.collapsedInstances.clear();
                document.querySelectorAll('.req-item').forEach(item => {
                    item.classList.remove('collapsed-by-parent');
                    item.classList.remove('hierarchy-visible');
                    const icon = item.querySelector('.collapse-icon');
                    if (icon) {
                        // Reset all icons first
                        icon.classList.remove('collapsed');
                        // Then collapse root items only
                        if (icon.textContent && item.dataset.isRoot === 'true') {
                            state.collapsedInstances.add(item.dataset.instanceId);
                            icon.classList.add('collapsed');
                        }
                    }
                });
            } else if (viewMode === 'uncommitted') {
                btnUncommitted.classList.add('active');
                treeTitle.textContent = 'Traceability Tree - Uncommitted Changes';
                document.querySelectorAll('.req-item').forEach(item => {
                    item.classList.remove('hierarchy-visible');
                });
                this.collapseAll();
            } else if (viewMode === 'branch') {
                btnBranch.classList.add('active');
                treeTitle.textContent = 'Traceability Tree - Changed vs Main';
                document.querySelectorAll('.req-item').forEach(item => {
                    item.classList.remove('hierarchy-visible');
                });
                this.collapseAll();
            } else {
                btnFlat.classList.add('active');
                treeTitle.textContent = 'Traceability Tree - Flat View';
                reqTree.classList.add('flat-view');
                // Reset all collapse state for flat view
                state.collapsedInstances.clear();
                document.querySelectorAll('.req-item').forEach(item => {
                    item.classList.remove('hierarchy-visible');
                    item.classList.remove('collapsed-by-parent');
                });
                // Reset all collapse icons to expanded state
                document.querySelectorAll('.collapse-icon').forEach(el => {
                    el.classList.remove('collapsed');
                });
            }

            applyFilters();
        }
    };

    // ==========================================================================
    // Filtering
    // ==========================================================================

    /**
     * Apply all filters to the requirement tree
     */
    function applyFilters() {
        const filterReqId = document.getElementById('filterReqId');
        const filterTitle = document.getElementById('filterTitle');
        const filterLevel = document.getElementById('filterLevel');
        const filterStatus = document.getElementById('filterStatus');
        const filterTopic = document.getElementById('filterTopic');
        const filterTests = document.getElementById('filterTests');
        const filterCoverage = document.getElementById('filterCoverage');
        const chkIncludeDeprecated = document.getElementById('chkIncludeDeprecated');
        const chkIncludeRoadmap = document.getElementById('chkIncludeRoadmap');

        const reqIdFilter = filterReqId ? filterReqId.value.toLowerCase().trim() : '';
        const titleFilter = filterTitle ? filterTitle.value.toLowerCase().trim() : '';
        const levelFilter = filterLevel ? filterLevel.value : '';
        const statusFilter = filterStatus ? filterStatus.value : '';
        const topicFilter = filterTopic ? filterTopic.value.toLowerCase().trim() : '';
        const testFilter = filterTests ? filterTests.value : '';
        const coverageFilter = filterCoverage ? filterCoverage.value : '';
        const isLeafOnly = state.leafOnlyActive;
        const includeDeprecated = chkIncludeDeprecated ? chkIncludeDeprecated.checked : false;
        const includeRoadmap = chkIncludeRoadmap ? chkIncludeRoadmap.checked : false;

        const isUncommittedView = state.currentView === 'uncommitted';
        const isBranchView = state.currentView === 'branch';
        const isModifiedView = isUncommittedView || isBranchView;
        const anyFilterActive = reqIdFilter || titleFilter || levelFilter || statusFilter ||
                               topicFilter || testFilter || coverageFilter || isLeafOnly || isModifiedView;

        let visibleCount = 0;
        const seenReqIds = new Set();
        const seenVisibleReqIds = new Set();
        const allReqIds = new Set();

        document.querySelectorAll('.req-item').forEach(item => {
            const reqId = item.dataset.reqId ? item.dataset.reqId.toLowerCase() : '';
            const isImplFile = item.classList.contains('impl-file');
            const status = item.dataset.status;

            if (!isImplFile && reqId) {
                if (includeDeprecated || status !== 'Deprecated') {
                    allReqIds.add(reqId);
                }
            }

            const level = item.dataset.level;
            const topic = item.dataset.topic ? item.dataset.topic.toLowerCase() : '';
            const title = item.dataset.title ? item.dataset.title.toLowerCase() : '';
            const isUncommitted = item.dataset.uncommitted === 'true';
            const isBranchChanged = item.dataset.branchChanged === 'true';

            let matches = true;

            if (isUncommittedView) {
                if (isImplFile) {
                    const parentId = item.dataset.parentInstanceId;
                    const parent = document.querySelector(`[data-instance-id="${parentId}"]`);
                    if (!parent || parent.dataset.uncommitted !== 'true') {
                        matches = false;
                    }
                } else if (!isUncommitted) {
                    matches = false;
                }
            }

            if (isBranchView) {
                if (isImplFile) {
                    const parentId = item.dataset.parentInstanceId;
                    const parent = document.querySelector(`[data-instance-id="${parentId}"]`);
                    if (!parent || parent.dataset.branchChanged !== 'true') {
                        matches = false;
                    }
                } else if (!isBranchChanged) {
                    matches = false;
                }
            }

            if (reqIdFilter && !reqId.includes(reqIdFilter)) matches = false;
            if (titleFilter && !title.includes(titleFilter)) matches = false;
            if (levelFilter && level !== levelFilter) matches = false;
            if (statusFilter && status !== statusFilter) matches = false;
            if (topicFilter && topic !== topicFilter && !topic.startsWith(topicFilter + '-')) {
                matches = false;
            }

            // Toggle filter: hidden levels (PRD/OPS/DEV buttons)
            if (matches && !isImplFile && TraceView.hiddenLevels && TraceView.hiddenLevels.has(level)) {
                matches = false;
            }

            // Toggle filter: hidden repos (CORE/CAL/TTN etc buttons)
            if (matches && !isImplFile && TraceView.hiddenRepos) {
                const repo = item.dataset.repo || 'CORE';  // Empty repo = CORE
                if (TraceView.hiddenRepos.has(repo)) {
                    matches = false;
                }
            }

            // Toggle filter: hide implementation files
            if (matches && isImplFile) {
                // Hide all files if Files toggle is off
                if (TraceView.hideFiles) {
                    matches = false;
                } else {
                    // Check if parent requirement is hidden (due to level/repo filter)
                    const parentInstanceId = item.dataset.parentInstanceId;
                    if (parentInstanceId) {
                        const parent = document.querySelector(`[data-instance-id="${parentInstanceId}"]`);
                        if (parent) {
                            const parentLevel = parent.dataset.level;
                            const parentRepo = parent.dataset.repo || 'CORE';
                            // Hide file if parent's level is hidden
                            if (TraceView.hiddenLevels && TraceView.hiddenLevels.has(parentLevel)) {
                                matches = false;
                            }
                            // Hide file if parent's repo is hidden
                            if (matches && TraceView.hiddenRepos && TraceView.hiddenRepos.has(parentRepo)) {
                                matches = false;
                            }
                        }
                    }
                }
            }

            if (testFilter && matches) {
                const testStatus = item.dataset.testStatus || 'not-tested';
                if (testFilter !== testStatus) matches = false;
            }

            if (coverageFilter && matches) {
                const coverage = item.dataset.coverage || 'none';
                if (coverageFilter !== coverage) matches = false;
            }

            if (isLeafOnly && matches && !isImplFile) {
                const hasChildren = item.dataset.hasChildren === 'true';
                if (hasChildren) matches = false;
            }

            if (!includeDeprecated && matches && !isImplFile) {
                if (status === 'Deprecated') matches = false;
            }

            if (!includeRoadmap && matches && !isImplFile) {
                const isRoadmap = item.dataset.roadmap === 'true';
                const isConflict = item.dataset.conflict === 'true';
                const isCycle = item.dataset.cycle === 'true';
                if (isRoadmap && !isConflict && !isCycle) matches = false;
            }

            if (matches && anyFilterActive && !isImplFile && seenReqIds.has(reqId)) {
                matches = false;
            }

            if (matches) {
                item.classList.remove('filtered-out');
                if (anyFilterActive) {
                    item.classList.remove('collapsed-by-parent');
                    // In hierarchy view, non-root items need hierarchy-visible to be shown
                    const isHierarchyView = state.currentView === 'hierarchy';
                    if (isHierarchyView && item.dataset.isRoot !== 'true') {
                        item.classList.add('hierarchy-visible');
                    }
                    if (!isImplFile) seenReqIds.add(reqId);
                }
                if (!isImplFile && reqId && !seenVisibleReqIds.has(reqId)) {
                    seenVisibleReqIds.add(reqId);
                    visibleCount++;
                }
            } else {
                item.classList.add('filtered-out');
            }
        });

        const totalCount = allReqIds.size;
        let statsText;
        if (isUncommittedView) {
            statsText = `Showing ${visibleCount} uncommitted requirements`;
        } else if (isBranchView) {
            statsText = `Showing ${visibleCount} requirements changed vs main`;
        } else {
            statsText = `Showing ${visibleCount} of ${totalCount} requirements`;
        }
        document.getElementById('filterStats').textContent = statsText;
        navigation.updateExpandCollapseButtons();
    }

    /**
     * Clear all filters
     */
    function clearFilters() {
        const filterReqId = document.getElementById('filterReqId');
        const filterTitle = document.getElementById('filterTitle');
        const filterLevel = document.getElementById('filterLevel');
        const filterStatus = document.getElementById('filterStatus');
        const filterTopic = document.getElementById('filterTopic');
        const filterTests = document.getElementById('filterTests');
        const filterCoverage = document.getElementById('filterCoverage');
        const btnLeafOnly = document.getElementById('btnLeafOnly');
        const chkIncludeDeprecated = document.getElementById('chkIncludeDeprecated');
        const chkIncludeRoadmap = document.getElementById('chkIncludeRoadmap');

        if (filterReqId) filterReqId.value = '';
        if (filterTitle) filterTitle.value = '';
        if (filterLevel) filterLevel.value = '';
        if (filterStatus) filterStatus.value = '';
        if (filterTopic) filterTopic.value = '';
        if (filterTests) filterTests.value = '';
        if (filterCoverage) filterCoverage.value = '';

        state.leafOnlyActive = false;
        if (btnLeafOnly) btnLeafOnly.classList.remove('active');
        if (chkIncludeDeprecated) chkIncludeDeprecated.checked = false;
        if (chkIncludeRoadmap) chkIncludeRoadmap.checked = false;

        toggleIncludeDeprecated();
    }

    // ==========================================================================
    // Leaf Only Filter
    // ==========================================================================

    /**
     * Toggle leaf-only filter
     */
    function toggleLeafOnly() {
        state.leafOnlyActive = !state.leafOnlyActive;
        const btn = document.getElementById('btnLeafOnly');
        if (state.leafOnlyActive) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
        applyFilters();
    }

    /**
     * Toggle include deprecated checkbox
     */
    function toggleIncludeDeprecated() {
        const includeDeprecated = document.getElementById('chkIncludeDeprecated').checked;

        ['PRD', 'OPS', 'DEV'].forEach(level => {
            const badge = document.getElementById('badge' + level);
            if (badge) {
                const count = includeDeprecated ? badge.dataset.all : badge.dataset.active;
                badge.textContent = level + ': ' + count;
            }
        });

        applyFilters();
    }

    /**
     * Toggle include roadmap checkbox
     */
    function toggleIncludeRoadmap() {
        applyFilters();
    }

    // ==========================================================================
    // Review Mode Toggle (REQ-tv-d00016)
    // ==========================================================================

    /**
     * Toggle review mode on/off
     * Shows/hides the review panel and updates body class for 3-column layout
     */
    function toggleReviewMode() {
        state.reviewModeActive = !state.reviewModeActive;
        const btn = document.getElementById('btnReviewMode');
        const panel = document.getElementById('review-panel');
        const packagesPanel = document.getElementById('rs-packages-panel');

        if (state.reviewModeActive) {
            // Activate review mode
            document.body.classList.add('review-mode-active');
            if (btn) btn.classList.add('active');
            if (panel) panel.classList.remove('hidden');
            if (packagesPanel) packagesPanel.style.display = 'block';

            // Initialize review system if available
            if (window.TraceView && window.TraceView.review) {
                window.TraceView.review.init();
            }
        } else {
            // Deactivate review mode
            document.body.classList.remove('review-mode-active');
            if (btn) btn.classList.remove('active');
            if (panel) panel.classList.add('hidden');
            if (packagesPanel) packagesPanel.style.display = 'none';
        }

        // Dispatch custom event for review system to respond to
        document.dispatchEvent(new CustomEvent('traceview:review-mode-changed', {
            detail: { active: state.reviewModeActive }
        }));
    }

    // ==========================================================================
    // Initialization (REQ-tv-d00003-J: addEventListener for dynamic elements)
    // ==========================================================================

    /**
     * Initialize TraceView
     */
    function init() {
        panel.initResize();

        // Close modals on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                codeViewer.close();
                legend.close();
                filePicker.close();
            }
        });

        // Sync review mode state with review system (REQ-d00092)
        // The review system dispatches this event when mode changes
        document.addEventListener('rs:review-mode-changed', function(e) {
            state.reviewModeActive = e.detail.active;
        });
    }

    // ==========================================================================
    // Public API
    // ==========================================================================

    return {
        // Sub-objects
        panel: panel,
        codeViewer: codeViewer,
        editMode: editMode,
        filePicker: filePicker,
        legend: legend,
        navigation: navigation,
        state: state,

        // Functions
        init: init,
        toggleLeafOnly: toggleLeafOnly,
        toggleIncludeDeprecated: toggleIncludeDeprecated,
        toggleIncludeRoadmap: toggleIncludeRoadmap,
        toggleReviewMode: toggleReviewMode,
        applyFilters: applyFilters,
        clearFilters: clearFilters
    };
})();

// ==========================================================================
// Global function aliases for backward compatibility with inline onclick handlers
// ==========================================================================

function openReqPanel(reqId) { TraceView.panel.open(reqId); }
function closeReqCard(reqId) { TraceView.panel.close(reqId); }
function closeAllCards() { TraceView.panel.closeAll(); }
function openCodeViewer(filePath, lineNum) { TraceView.codeViewer.open(filePath, lineNum); }
function closeCodeViewer() { TraceView.codeViewer.close(); }
function openLegendModal() { TraceView.legend.open(); }
function closeLegendModal() { TraceView.legend.close(); }
function toggleEditMode() { TraceView.editMode.toggle(); }
function addPendingMove(reqId, sourceFile, moveType) { TraceView.editMode.addMove(reqId, sourceFile, moveType); }
function removePendingMove(index) { TraceView.editMode.removeMove(index); }
function clearPendingMoves() { TraceView.editMode.clearMoves(); }
function togglePendingMoves() { TraceView.editMode.togglePendingMoves(); }
function applyMoves() { TraceView.editMode.applyMoves(); }
function showMoveToFile(reqId, sourceFile) { TraceView.filePicker.show(reqId, sourceFile); }
function closeFilePicker() { TraceView.filePicker.close(); }
function filterFiles(value) { TraceView.filePicker.filter(value); }
function selectFile(filename) { TraceView.filePicker.select(filename); }
function confirmFilePicker() { TraceView.filePicker.confirm(); }
function toggleLeafOnly() { TraceView.toggleLeafOnly(); }
function toggleIncludeDeprecated() { TraceView.toggleIncludeDeprecated(); }
function toggleIncludeRoadmap() { TraceView.toggleIncludeRoadmap(); }
function toggleReviewMode() { TraceView.toggleReviewMode(); }

// Navigation functions
function toggleRequirement(element) { TraceView.navigation.toggleRequirement(element); }
function expandAll() { TraceView.navigation.expandAll(); }
function collapseAll() { TraceView.navigation.collapseAll(); }
function switchView(viewMode) { TraceView.navigation.switchView(viewMode); }
function applyFilters() { TraceView.applyFilters(); }
function clearFilters() { TraceView.clearFilters(); }

// Toggle filters - independent on/off toggles for levels and repos
// Track hidden items - everything starts visible, clicking hides them
TraceView.hiddenLevels = TraceView.hiddenLevels || new Set();
TraceView.hiddenRepos = TraceView.hiddenRepos || new Set();

// Toggle level filter (PRD/OPS/DEV) - independent on/off
function filterByLevel(level) {
    const badge = document.getElementById('badge' + level);
    if (!badge) return;

    if (TraceView.hiddenLevels.has(level)) {
        // Currently hidden, show it
        TraceView.hiddenLevels.delete(level);
        badge.classList.remove('filter-hidden');
    } else {
        // Currently visible, hide it
        TraceView.hiddenLevels.add(level);
        badge.classList.add('filter-hidden');
    }
    applyFilters();
}

// Toggle repo filter (CORE, CAL, TTN, etc.) - independent on/off
function toggleRepoFilter(repoPrefix) {
    const badge = document.getElementById('badgeRepo' + repoPrefix);
    if (!badge) return;

    if (TraceView.hiddenRepos.has(repoPrefix)) {
        // Currently hidden, show it
        TraceView.hiddenRepos.delete(repoPrefix);
        badge.classList.remove('filter-hidden');
    } else {
        // Currently visible, hide it
        TraceView.hiddenRepos.add(repoPrefix);
        badge.classList.add('filter-hidden');
    }
    applyFilters();
}

// Toggle files filter - show/hide implementation files
TraceView.hideFiles = false;  // Files visible by default

function toggleFilesFilter() {
    const badge = document.getElementById('badgeFiles');
    if (!badge) return;

    TraceView.hideFiles = !TraceView.hideFiles;
    if (TraceView.hideFiles) {
        badge.classList.add('filter-hidden');
    } else {
        badge.classList.remove('filter-hidden');
    }
    applyFilters();
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', function() {
    TraceView.init();
    // Start with hierarchical view - show tree structure with collapsible nodes
    TraceView.navigation.switchView('hierarchy');
});

</script>


<div id="file-picker-modal" class="file-picker-modal hidden" onclick="if(event.target===this)closeFilePicker()">
    <div class="file-picker-container">
        <div class="file-picker-header">
            <h2>Select Destination File</h2>
            <button class="file-picker-close" onclick="closeFilePicker()">√ó</button>
        </div>
        <div class="file-picker-body">
            <div class="file-picker-input-row">
                <input type="text" id="filePickerInput" placeholder="Enter or select filename (e.g., prd-security.md)"
                       oninput="filterFiles(this.value)"
                       onkeydown="if(event.key==='Enter'){confirmFilePicker();event.preventDefault();}">
                <button class="btn" onclick="confirmFilePicker()">Confirm</button>
            </div>
            <div id="filePickerError" class="file-picker-error" style="display: none;"></div>
            <div class="file-picker-hint">Click a file below to select it, or type a new filename</div>
            <div id="filePickerList" class="file-picker-list"></div>
        </div>
    </div>
</div>
</body>
</html>