{# Implements: REQ-p00006-A, REQ-d00010-A #}
{# Unified trace template ‚Äî mode="view" for static HTML, mode="edit" for Flask server #}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% if mode == 'edit' %}
    <title>Trace Edit - Requirements Editor</title>
    {% else %}
    <title>Requirements Traceability</title>
    {% endif %}
    <style>
/* Implements: REQ-p00006-A */
{% include "partials/css/_base.css.j2" %}

{% if mode == 'edit' %}
/* Edit body overrides */
body {
    overflow: hidden;
    height: 100vh;
    display: flex;
    flex-direction: column;
}
{% include "partials/css/_header-edit.css.j2" %}
{% include "partials/css/_buttons.css.j2" %}
{% include "partials/css/_toast.css.j2" %}
{% include "partials/css/_nav-panel.css.j2" %}
{% include "partials/css/_dividers.css.j2" %}
{% include "partials/css/_card-stack.css.j2" %}
{% include "partials/css/_edit-mode.css.j2" %}
{% include "partials/css/_file-viewer-edit.css.j2" %}
{% include "partials/css/_dark-theme.css.j2" %}
/* Edit responsive */
@media (max-width: 768px) {
    .header { flex-direction: column; align-items: flex-start; }
    .header-center { min-width: 100%; }
    .layout { flex-direction: column; }
    .nav-panel { width: 100% !important; max-width: 100% !important; height: 40vh; border-right: none; border-bottom: 1px solid #e9ecef; }
    .file-viewer-panel { width: 100% !important; max-width: 100% !important; border-left: none; border-top: 1px solid #e9ecef; }
}
{% else %}
{% include "partials/css/_header.css.j2" %}
{% include "partials/css/_toolbar.css.j2" %}
{% include "partials/css/_tabs.css.j2" %}
{% include "partials/css/_table.css.j2" %}
{% include "partials/css/_tree-structure.css.j2" %}
{% include "partials/css/_status-badges.css.j2" %}
{% include "partials/css/_coverage.css.j2" %}
{% include "partials/css/_topic-tags.css.j2" %}
{% include "partials/css/_code-test-rows.css.j2" %}
{% include "partials/css/_journey.css.j2" %}
{% include "partials/css/_legend.css.j2" %}
{% include "partials/css/_file-viewer.css.j2" %}
{% include "partials/css/_responsive.css.j2" %}
/* Pygments syntax highlighting theme */
{% if pygments_css %}
{{ pygments_css }}
{% endif %}
{% endif %}
    </style>
</head>
<body>

{% include "partials/_header.html.j2" %}

{% include "partials/_toast_container.html.j2" %}

{% include "partials/_toolbar.html.j2" %}

{% include "partials/_tabs.html.j2" %}

{% if mode == 'edit' %}
<!-- =====================================================================
     3-PANEL LAYOUT
     ===================================================================== -->

<div class="layout" id="layout">

    <!-- Nav Panel (Left) -->
    <nav class="nav-panel" id="nav-panel">
        <div class="nav-tabs">
            <button class="nav-tab active" data-kind="req" onclick="switchNavTab('req')">Req</button>
            <button class="nav-tab" data-kind="code" onclick="switchNavTab('code')">Code</button>
            <button class="nav-tab" data-kind="test" onclick="switchNavTab('test')">Tests</button>
            <button class="nav-tab" data-kind="journey" onclick="switchNavTab('journey')">Journeys</button>
        </div>
        <div class="nav-tree-container" id="nav-tree-container">
            <div style="padding:20px;color:#adb5bd;text-align:center;font-size:0.85rem;">Loading tree...</div>
        </div>
    </nav>

    <!-- Divider 1 (nav | cards) -->
    <div class="divider" id="divider-left"></div>

    <!-- Card Stack (Center) -->
    <div class="card-stack-panel" id="card-stack-panel">
        <div class="card-stack-header">
            <span id="card-stack-count">No cards open</span>
            <button class="btn" onclick="closeAllCards()" style="padding:3px 8px;font-size:0.75rem;">Close All</button>
        </div>
        <div class="card-stack-body" id="card-stack-body">
            <div class="card-stack-empty" id="card-stack-empty">
                <div class="card-stack-empty-icon">&#128196;</div>
                <div>Click a requirement in the tree to open it</div>
                <div style="font-size:0.75rem;">Cards will appear here</div>
            </div>
        </div>
    </div>

    <!-- Divider 2 (cards | file viewer) -->
    <div class="divider" id="divider-right" style="display:none;"></div>

    <!-- File Viewer Panel (Right) -->
    {% include "partials/_file_viewer.html.j2" %}

</div>

{% else %}
<!-- =====================================================================
     SPLIT LAYOUT: MAIN CONTENT + FILE VIEWER
     ===================================================================== -->

<div class="split-layout" id="split-layout">
<main class="main-content" id="main-content">
    <!-- Requirements Tab Content -->
    <div class="tab-content active" id="content-requirements">
        <h2 class="section-title">Traceability Tree - <span id="view-mode-label">Hierarchical View</span></h2>

        <div class="table-container">
        <table class="trace-table" id="trace-table">
            <thead>
                <tr>
                    <th class="col-id">
                        ID
                        <input type="text" class="filter-input" id="filter-id" placeholder="e.g. p00001" oninput="applyFilters()">
                    </th>
                    <th class="col-title">
                        TITLE
                        <input type="text" class="filter-input" id="filter-title" placeholder="Search title..." oninput="applyFilters()">
                    </th>
                    <th class="col-level">
                        LEVEL
                        <select class="filter-select" id="filter-level" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="PRD">PRD</option>
                            <option value="OPS">OPS</option>
                            <option value="DEV">DEV</option>
                        </select>
                    </th>
                    <th class="col-status">
                        STATUS
                        <select class="filter-select" id="filter-status" onchange="applyFilters()">
                            <option value="">All</option>
                            {% for status in statuses %}
                            <option value="{{ status }}">{{ status }}</option>
                            {% endfor %}
                        </select>
                    </th>
                    <th class="col-cov">
                        COV
                        <select class="filter-select" id="filter-cov" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="none">‚óã None</option>
                            <option value="partial">‚óê Partial</option>
                            <option value="full">‚óè Full</option>
                        </select>
                    </th>
                    <th class="col-topic">
                        TOPIC
                        <select class="filter-select" id="filter-topic" onchange="applyFilters()">
                            <option value="">All</option>
                            {% for topic in topics %}
                            <option value="{{ topic }}">{{ topic }}</option>
                            {% endfor %}
                        </select>
                    </th>
                </tr>
            </thead>
            <tbody id="table-body">
                {% for row in rows %}
                <tr class="req-row {{ 'code-row' if row.is_code else '' }}{{ 'test-row' if row.is_test else '' }}{{ 'result-row ' + row.result_status if row.is_test_result else '' }}"
                    data-id="{{ row.id }}"
                    data-parent="{{ row.parent_id or '' }}"
                    data-level="{{ row.level }}"
                    data-status="{{ row.status }}"
                    data-coverage="{{ row.coverage }}"
                    data-coverage-indirect="{{ row.coverage_indirect }}"
                    data-topic="{{ row.topic }}"
                    data-depth="{{ row.depth }}"
                    data-is-leaf="{{ 'true' if row.is_leaf else 'false' }}"
                    data-is-changed="{{ 'true' if row.is_changed else 'false' }}"
                    data-is-uncommitted="{{ 'true' if row.is_uncommitted else 'false' }}"
                    data-is-roadmap="{{ 'true' if row.is_roadmap else 'false' }}"
                    data-is-code="{{ 'true' if row.is_code else 'false' }}"
                    data-is-test="{{ 'true' if row.is_test else 'false' }}"
                    data-is-test-result="{{ 'true' if row.is_test_result else 'false' }}"
                    data-result-status="{{ row.result_status }}"
                    data-is-associated="{{ 'true' if row.is_associated else 'false' }}"
                    data-has-children="{{ 'true' if row.has_children else 'false' }}"
                    data-source-file="{{ row.source_file }}"
                    data-source-line="{{ row.source_line }}">
                    <td class="col-id">
                        <div class="tree-cell">
                            {% for i in range(row.depth) %}
                            <span class="tree-indent"></span>
                            {% endfor %}
                            <button class="tree-toggle {{ 'expanded' if row.has_children else 'leaf' }}"
                                    onclick="toggleNode('{{ row.id }}')"
                                    data-node-id="{{ row.id }}"></button>
                            {% if row.is_code %}
                            <span class="code-icon">üìÑ</span>
                            {% elif row.is_test %}
                            <span class="test-icon">üß™</span>
                            {% elif row.is_test_result %}
                            <span class="result-icon">{% if row.result_status == 'passed' %}‚úÖ{% elif row.result_status in ['failed', 'failure'] %}‚ùå{% elif row.result_status == 'error' %}‚ö†Ô∏è{% elif row.result_status == 'skipped' %}‚è≠Ô∏è{% else %}üìã{% endif %}</span>
                            {% endif %}
                            {% if row.source_file %}
                            <a href="vscode://file/{{ row.source_file }}:{{ row.source_line }}:1" class="req-id" title="Open in VS Code: {{ row.source_file }}:{{ row.source_line }}">{{ row.display_id | replace('REQ-', '') }}</a>
                            {% else %}
                            <span class="req-id">{{ row.display_id | replace('REQ-', '') }}</span>
                            {% endif %}
                            {% if row.assertions %}
                            <span class="assertion-badges">
                                {% for a in row.assertions %}
                                <span class="assertion-badge">{{ a }}</span>
                                {% endfor %}
                            </span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="col-title">
                        {% if row.is_test_result %}
                        {% if row.source_file %}
                        <a href="vscode://file/{{ row.source_file }}:{{ row.source_line }}:1" class="file-link" title="Open in VS Code">{{ row.title }}</a>
                        {% else %}
                        {{ row.title }}
                        {% endif %}
                        <span class="result-badge {{ row.result_status }}">{{ row.result_status }}</span>
                        {% elif (row.is_test or row.is_code) and row.source_file %}
                        <a href="vscode://file/{{ row.source_file }}:{{ row.source_line }}:1" class="file-link" title="Open in VS Code">{{ row.title }}</a>
                        {% else %}
                        {{ row.title }}
                        {% endif %}
                    </td>
                    <td class="col-level">{{ row.level }}</td>
                    <td class="col-status">
                        {% if row.status %}
                        <span class="status-badge {{ row.status|lower }}">
                            {{ row.status }}
                            {% if row.is_changed %}<span class="change-indicator">‚óÜ</span>{% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td class="col-cov">
                        <div class="coverage-cell">
                            {% if row.coverage == 'full' %}
                            <span class="coverage-icon full">‚óè</span>
                            {% elif row.coverage == 'partial' %}
                            <span class="coverage-icon partial">‚óê</span>
                            {% else %}
                            <span class="coverage-icon none">‚óã</span>
                            {% endif %}
                            {% if row.has_failures %}
                            <span class="warning-icon">‚ö°</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="col-topic">
                        <span class="topic-tag">{{ row.topic }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>

    <!-- User Journeys Tab Content -->
    {% include "partials/_journey_tab.html.j2" %}
</main>

<div class="split-divider" id="split-divider"></div>

{% include "partials/_file_viewer.html.j2" %}

</div><!-- end split-layout -->

{% endif %}

{% include "partials/_legend_modal.html.j2" %}

{% if mode == 'view' %}
<!-- =====================================================================
     EMBEDDED DATA
     ===================================================================== -->

<script type="application/json" id="tree-data">
{{ tree_data | tojson }}
</script>

<script type="application/json" id="source-files">
{{ source_files | tojson }}
</script>
{% endif %}

<!-- =====================================================================
     JAVASCRIPT
     ===================================================================== -->

<script>
const MODE = '{{ mode }}';

{% include "partials/js/_utils.js.j2" %}

{% if mode == 'edit' %}
// State
const editState = {
    enabled: false,
    openCards: new Map(),
    openCardOrder: [],
    dirtyFields: new Map(),
    mutationCount: 0,
    activeNavTab: 'req',
    treeData: [],
    collapsedTreeNodes: new Set(),
    searchDebounce: null
};
{% else %}
// State
const state = {
    viewMode: 'hierarchical',
    activeFilters: {
        uncommitted: false,
        changed: false,
        code: false,
        tests: false,
        results: false,
        associated: false,
        core: false,
        levelPrd: false,
        levelOps: false,
        levelDev: false
    },
    collapsedNodes: new Set(),
    totalCount: {{ stats.total_count }},
    activeTab: 'requirements',
    treeData: JSON.parse(document.getElementById('tree-data').textContent),
    sourceFiles: JSON.parse(document.getElementById('source-files').textContent),
    fileViewerOpen: false,
    currentFile: null,
    fileViewMode: 'source',
    splitRatio: 50,
    indirectCoverage: false
};
{% endif %}

{% include "partials/js/_cookie-persistence.js.j2" %}

{% if mode == 'edit' %}
{% include "partials/js/_edit-engine.js.j2" %}
{% include "partials/js/_nav-tree.js.j2" %}
{% include "partials/js/_card-stack.js.j2" %}
{% else %}
{% include "partials/js/_filter-engine.js.j2" %}
{% include "partials/js/_journey-engine.js.j2" %}
{% endif %}

{% include "partials/js/_file-viewer.js.j2" %}
{% include "partials/js/_divider.js.j2" %}

{% if mode == 'edit' %}
// Keyboard Shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (document.getElementById('file-viewer-panel').classList.contains('open')) {
            closeFileViewer();
        }
    }
    if (e.key === 'e' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        toggleEditMode();
    }
    if (e.key === 'z' && (e.ctrlKey || e.metaKey) && !e.target.isContentEditable && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        doUndo();
    }
    if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        document.getElementById('search-input').focus();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadTreeData();
    initSearch();
    initDividers();
    refreshDirtyCount();

    const saved = loadState();
    if (saved) {
        if (saved.activeNavTab) {
            editState.activeNavTab = saved.activeNavTab;
            document.querySelectorAll('.nav-tab').forEach(function(tab) {
                tab.classList.toggle('active', tab.dataset.kind === saved.activeNavTab);
            });
        }
        if (saved.editEnabled) {
            toggleEditMode();
        }
        if (saved.collapsedTreeNodes && Array.isArray(saved.collapsedTreeNodes)) {
            editState.collapsedTreeNodes = new Set(saved.collapsedTreeNodes);
        }
        if (saved.openCardIds && saved.openCardIds.length > 0) {
            const collapsedSet = new Set(saved.collapsedCards || []);
            const ids = saved.openCardIds.slice().reverse();
            (async function restoreCards() {
                for (const id of ids) {
                    const data = await apiFetch('/api/requirement/' + encodeURIComponent(id));
                    if (data && !data.error) {
                        editState.openCards.set(id, {
                            data: data,
                            collapsed: collapsedSet.has(id)
                        });
                        editState.openCardOrder.push(id);
                    }
                }
                editState.openCardOrder.reverse();
                renderCardStack();
                updateNavSelection();
                if (editState.enabled) {
                    document.querySelectorAll('.card-assertion-text').forEach(function(el) {
                        el.contentEditable = 'true';
                    });
                    document.querySelectorAll('.edit-only').forEach(function(el) {
                        el.style.display = '';
                    });
                }
            })();
        }
    }
});

{% else %}
// Keyboard Shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (state.fileViewerOpen) {
            closeFileViewer();
        } else {
            const modal = document.getElementById('legend-modal');
            if (modal.classList.contains('visible')) {
                toggleLegend();
            }
        }
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    const hasSavedState = loadStateFromCookie();

    if (hasSavedState) {
        restoreState();
    } else {
        collapseAll();
    }

    interceptFileLinks();
    applyFilters();
});
{% endif %}
</script>

</body>
</html>
