<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirements Traceability</title>
    <style>
/* Implements: REQ-p00006-A */
{% include "partials/css/_base.css.j2" %}
{% include "partials/css/_header.css.j2" %}
{% include "partials/css/_toolbar.css.j2" %}
{% include "partials/css/_tabs.css.j2" %}
{% include "partials/css/_table.css.j2" %}
{% include "partials/css/_tree-structure.css.j2" %}
{% include "partials/css/_status-badges.css.j2" %}
{% include "partials/css/_coverage.css.j2" %}
{% include "partials/css/_topic-tags.css.j2" %}
{% include "partials/css/_code-test-rows.css.j2" %}
{% include "partials/css/_journey.css.j2" %}
{% include "partials/css/_legend.css.j2" %}
{% include "partials/css/_file-viewer.css.j2" %}
{% include "partials/css/_responsive.css.j2" %}
/* Pygments syntax highlighting theme */
{% if pygments_css %}
{{ pygments_css }}
{% endif %}
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

{% include "partials/_header.html.j2" %}

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOOLBAR
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

{% include "partials/_toolbar.html.j2" %}

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TABS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

{% include "partials/_tabs.html.j2" %}

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SPLIT LAYOUT: MAIN CONTENT + FILE VIEWER
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="split-layout" id="split-layout">
<main class="main-content" id="main-content">
    <!-- Requirements Tab Content -->
    <div class="tab-content active" id="content-requirements">
        <h2 class="section-title">Traceability Tree - <span id="view-mode-label">Hierarchical View</span></h2>

        <div class="table-container">
        <table class="trace-table" id="trace-table">
            <thead>
                <tr>
                    <th class="col-id">
                        ID
                        <input type="text" class="filter-input" id="filter-id" placeholder="e.g. p00001" oninput="applyFilters()">
                    </th>
                    <th class="col-title">
                        TITLE
                        <input type="text" class="filter-input" id="filter-title" placeholder="Search title..." oninput="applyFilters()">
                    </th>
                    <th class="col-level">
                        LEVEL
                        <select class="filter-select" id="filter-level" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="PRD">PRD</option>
                            <option value="OPS">OPS</option>
                            <option value="DEV">DEV</option>
                        </select>
                    </th>
                    <th class="col-status">
                        STATUS
                        <select class="filter-select" id="filter-status" onchange="applyFilters()">
                            <option value="">All</option>
                            {% for status in statuses %}
                            <option value="{{ status }}">{{ status }}</option>
                            {% endfor %}
                        </select>
                    </th>
                    <th class="col-cov">
                        COV
                        <select class="filter-select" id="filter-cov" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="none">â—‹ None</option>
                            <option value="partial">â— Partial</option>
                            <option value="full">â— Full</option>
                        </select>
                    </th>
                    <th class="col-topic">
                        TOPIC
                        <select class="filter-select" id="filter-topic" onchange="applyFilters()">
                            <option value="">All</option>
                            {% for topic in topics %}
                            <option value="{{ topic }}">{{ topic }}</option>
                            {% endfor %}
                        </select>
                    </th>
                </tr>
            </thead>
            <tbody id="table-body">
                {% for row in rows %}
                <tr class="req-row {{ 'code-row' if row.is_code else '' }}{{ 'test-row' if row.is_test else '' }}{{ 'result-row ' + row.result_status if row.is_test_result else '' }}"
                    data-id="{{ row.id }}"
                    data-parent="{{ row.parent_id or '' }}"
                    data-level="{{ row.level }}"
                    data-status="{{ row.status }}"
                    data-coverage="{{ row.coverage }}"
                    data-coverage-indirect="{{ row.coverage_indirect }}"
                    data-topic="{{ row.topic }}"
                    data-depth="{{ row.depth }}"
                    data-is-leaf="{{ 'true' if row.is_leaf else 'false' }}"
                    data-is-changed="{{ 'true' if row.is_changed else 'false' }}"
                    data-is-uncommitted="{{ 'true' if row.is_uncommitted else 'false' }}"
                    data-is-roadmap="{{ 'true' if row.is_roadmap else 'false' }}"
                    data-is-code="{{ 'true' if row.is_code else 'false' }}"
                    data-is-test="{{ 'true' if row.is_test else 'false' }}"
                    data-is-test-result="{{ 'true' if row.is_test_result else 'false' }}"
                    data-result-status="{{ row.result_status }}"
                    data-is-associated="{{ 'true' if row.is_associated else 'false' }}"
                    data-has-children="{{ 'true' if row.has_children else 'false' }}"
                    data-source-file="{{ row.source_file }}"
                    data-source-line="{{ row.source_line }}">
                    <td class="col-id">
                        <div class="tree-cell">
                            {% for i in range(row.depth) %}
                            <span class="tree-indent"></span>
                            {% endfor %}
                            <button class="tree-toggle {{ 'expanded' if row.has_children else 'leaf' }}"
                                    onclick="toggleNode('{{ row.id }}')"
                                    data-node-id="{{ row.id }}"></button>
                            {% if row.is_code %}
                            <span class="code-icon">ğŸ“„</span>
                            {% elif row.is_test %}
                            <span class="test-icon">ğŸ§ª</span>
                            {% elif row.is_test_result %}
                            <span class="result-icon">{% if row.result_status == 'passed' %}âœ…{% elif row.result_status in ['failed', 'failure'] %}âŒ{% elif row.result_status == 'error' %}âš ï¸{% elif row.result_status == 'skipped' %}â­ï¸{% else %}ğŸ“‹{% endif %}</span>
                            {% endif %}
                            {% if row.source_file %}
                            <a href="vscode://file/{{ row.source_file }}:{{ row.source_line }}:1" class="req-id" title="Open in VS Code: {{ row.source_file }}:{{ row.source_line }}">{{ row.display_id | replace('REQ-', '') }}</a>
                            {% else %}
                            <span class="req-id">{{ row.display_id | replace('REQ-', '') }}</span>
                            {% endif %}
                            {% if row.assertions %}
                            <span class="assertion-badges">
                                {% for a in row.assertions %}
                                <span class="assertion-badge">{{ a }}</span>
                                {% endfor %}
                            </span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="col-title">
                        {% if row.is_test_result %}
                        {% if row.source_file %}
                        <a href="vscode://file/{{ row.source_file }}:{{ row.source_line }}:1" class="file-link" title="Open in VS Code">{{ row.title }}</a>
                        {% else %}
                        {{ row.title }}
                        {% endif %}
                        <span class="result-badge {{ row.result_status }}">{{ row.result_status }}</span>
                        {% elif (row.is_test or row.is_code) and row.source_file %}
                        <a href="vscode://file/{{ row.source_file }}:{{ row.source_line }}:1" class="file-link" title="Open in VS Code">{{ row.title }}</a>
                        {% else %}
                        {{ row.title }}
                        {% endif %}
                    </td>
                    <td class="col-level">{{ row.level }}</td>
                    <td class="col-status">
                        {% if row.status %}
                        <span class="status-badge {{ row.status|lower }}">
                            {{ row.status }}
                            {% if row.is_changed %}<span class="change-indicator">â—†</span>{% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td class="col-cov">
                        <div class="coverage-cell">
                            {% if row.coverage == 'full' %}
                            <span class="coverage-icon full">â—</span>
                            {% elif row.coverage == 'partial' %}
                            <span class="coverage-icon partial">â—</span>
                            {% else %}
                            <span class="coverage-icon none">â—‹</span>
                            {% endif %}
                            {% if row.has_failures %}
                            <span class="warning-icon">âš¡</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="col-topic">
                        <span class="topic-tag">{{ row.topic }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>

    <!-- User Journeys Tab Content -->
    {% include "partials/_journey_tab.html.j2" %}
</main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESIZABLE DIVIDER + FILE VIEWER PANEL
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="split-divider" id="split-divider"></div>

{% include "partials/_file_viewer.html.j2" %}

</div><!-- end split-layout -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LEGEND MODAL
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

{% include "partials/_legend_modal.html.j2" %}

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EMBEDDED DATA
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<script type="application/json" id="tree-data">
{{ tree_data | tojson }}
</script>

<script type="application/json" id="source-files">
{{ source_files | tojson }}
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Utilities
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{% include "partials/js/_utils.js.j2" %}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const state = {
    viewMode: 'hierarchical',
    activeFilters: {
        uncommitted: false,
        changed: false,
        code: false,
        tests: false,
        results: false,
        associated: false,
        core: false,
        levelPrd: false,
        levelOps: false,
        levelDev: false
    },
    collapsedNodes: new Set(),
    totalCount: {{ stats.total_count }},
    activeTab: 'requirements',
    treeData: JSON.parse(document.getElementById('tree-data').textContent),
    sourceFiles: JSON.parse(document.getElementById('source-files').textContent),
    fileViewerOpen: false,
    currentFile: null,
    fileViewMode: 'source', // 'source' or 'rendered'
    splitRatio: 50, // percentage width for file viewer
    indirectCoverage: false // show indirect (whole-req test) coverage
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Cookie Persistence
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{% include "partials/js/_cookie-persistence.js.j2" %}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Filters, Toggles, Tree, Tabs, Legend
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{% include "partials/js/_filter-engine.js.j2" %}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Journey Filtering and Grouping
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{% include "partials/js/_journey-engine.js.j2" %}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// File Viewer
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{% include "partials/js/_file-viewer.js.j2" %}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Resizable Divider
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{% include "partials/js/_divider.js.j2" %}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Keyboard Shortcuts
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Escape closes file viewer first, then legend modal
        if (state.fileViewerOpen) {
            closeFileViewer();
        } else {
            const modal = document.getElementById('legend-modal');
            if (modal.classList.contains('visible')) {
                toggleLegend();
            }
        }
    }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Initialize
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('DOMContentLoaded', function() {
    // Check if there's saved state to restore
    const hasSavedState = loadStateFromCookie();

    if (hasSavedState) {
        // Restore saved state from cookie (includes collapsed nodes)
        restoreState();
    } else {
        // No saved state - start with tree collapsed (default state)
        collapseAll();
    }

    // Set up file link interception for inline viewer
    interceptFileLinks();

    // Apply filters (this will also save state)
    applyFilters();
});
</script>

</body>
</html>
