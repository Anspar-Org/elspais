{# Implements: REQ-p00006-A, REQ-d00010-A, REQ-d00010-G #}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace Edit - Requirements Editor</title>
    <style>
/* Implements: REQ-p00006-A */
{% include "partials/css/_base.css.j2" %}
/* Edit body overrides */
body {
    overflow: hidden;
    height: 100vh;
    display: flex;
    flex-direction: column;
}
{% include "partials/css/_header-edit.css.j2" %}
{% include "partials/css/_buttons.css.j2" %}
{% include "partials/css/_toast.css.j2" %}
{% include "partials/css/_nav-panel.css.j2" %}
{% include "partials/css/_dividers.css.j2" %}
{% include "partials/css/_card-stack.css.j2" %}
{% include "partials/css/_edit-mode.css.j2" %}
{% include "partials/css/_file-viewer-edit.css.j2" %}
{% include "partials/css/_dark-theme.css.j2" %}
/* Edit responsive */
@media (max-width: 768px) {
    .header { flex-direction: column; align-items: flex-start; }
    .header-center { min-width: 100%; }
    .layout { flex-direction: column; }
    .nav-panel { width: 100% !important; max-width: 100% !important; height: 40vh; border-right: none; border-bottom: 1px solid #e9ecef; }
    .file-viewer-panel { width: 100% !important; max-width: 100% !important; border-left: none; border-top: 1px solid #e9ecef; }
}
    </style>
</head>
<body>

<!-- =====================================================================
     HEADER
     ===================================================================== -->

{% include "partials/_header.html.j2" %}

<!-- =====================================================================
     TOAST CONTAINER
     ===================================================================== -->

{% include "partials/_toast_container.html.j2" %}

<!-- =====================================================================
     3-PANEL LAYOUT
     ===================================================================== -->

<div class="layout" id="layout">

    <!-- Nav Panel (Left) -->
    <nav class="nav-panel" id="nav-panel">
        <div class="nav-tabs">
            <button class="nav-tab active" data-kind="req" onclick="switchNavTab('req')">Req</button>
            <button class="nav-tab" data-kind="code" onclick="switchNavTab('code')">Code</button>
            <button class="nav-tab" data-kind="test" onclick="switchNavTab('test')">Tests</button>
            <button class="nav-tab" data-kind="journey" onclick="switchNavTab('journey')">Journeys</button>
        </div>
        <div class="nav-tree-container" id="nav-tree-container">
            <div style="padding:20px;color:#adb5bd;text-align:center;font-size:0.85rem;">Loading tree...</div>
        </div>
    </nav>

    <!-- Divider 1 (nav | cards) -->
    <div class="divider" id="divider-left"></div>

    <!-- Card Stack (Center) -->
    <div class="card-stack-panel" id="card-stack-panel">
        <div class="card-stack-header">
            <span id="card-stack-count">No cards open</span>
            <button class="btn" onclick="closeAllCards()" style="padding:3px 8px;font-size:0.75rem;">Close All</button>
        </div>
        <div class="card-stack-body" id="card-stack-body">
            <div class="card-stack-empty" id="card-stack-empty">
                <div class="card-stack-empty-icon">&#128196;</div>
                <div>Click a requirement in the tree to open it</div>
                <div style="font-size:0.75rem;">Cards will appear here</div>
            </div>
        </div>
    </div>

    <!-- Divider 2 (cards | file viewer) -->
    <div class="divider" id="divider-right" style="display:none;"></div>

    <!-- File Viewer Panel (Right) -->
    {% include "partials/_file_viewer.html.j2" %}

</div>

<!-- =====================================================================
     JAVASCRIPT
     ===================================================================== -->

<script>
// =====================================================================
// Utilities
// =====================================================================

{% include "partials/js/_utils.js.j2" %}

// =====================================================================
// State
// =====================================================================

const editState = {
    enabled: false,
    openCards: new Map(),       // nodeId -> {data, collapsed}
    openCardOrder: [],          // nodeId[] â€” most recent first
    dirtyFields: new Map(),     // fieldKey -> {endpoint, payload, original}
    mutationCount: 0,
    activeNavTab: 'req',
    treeData: [],
    collapsedTreeNodes: new Set(),
    searchDebounce: null
};

// =====================================================================
// Cookie Persistence
// =====================================================================

{% include "partials/js/_cookie-persistence.js.j2" %}

// =====================================================================
// API Helpers, Toast, Edit Mode, Edit Handlers, Save/Revert/Undo, Search
// =====================================================================

{% include "partials/js/_edit-engine.js.j2" %}

// =====================================================================
// Nav Tree
// =====================================================================

{% include "partials/js/_nav-tree.js.j2" %}

// =====================================================================
// Card Stack
// =====================================================================

{% include "partials/js/_card-stack.js.j2" %}

// =====================================================================
// File Viewer
// =====================================================================

{% include "partials/js/_file-viewer.js.j2" %}

// =====================================================================
// Resizable Dividers
// =====================================================================

{% include "partials/js/_divider.js.j2" %}

// =====================================================================
// Keyboard Shortcuts
// =====================================================================

document.addEventListener('keydown', function(e) {
    // Escape closes file viewer first
    if (e.key === 'Escape') {
        if (document.getElementById('file-viewer-panel').classList.contains('open')) {
            closeFileViewer();
        }
    }

    // Ctrl+E toggles edit mode
    if (e.key === 'e' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        toggleEditMode();
    }

    // Ctrl+Z = undo (only when not in a text field)
    if (e.key === 'z' && (e.ctrlKey || e.metaKey) && !e.target.isContentEditable && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        doUndo();
    }

    // Ctrl+K = focus search
    if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        document.getElementById('search-input').focus();
    }
});

// =====================================================================
// Initialize
// =====================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadStats();
    loadTreeData();
    initSearch();
    initDividers();
    refreshDirtyCount();

    // Restore saved state
    const saved = loadState();
    if (saved) {
        // Restore nav tab
        if (saved.activeNavTab) {
            editState.activeNavTab = saved.activeNavTab;
            document.querySelectorAll('.nav-tab').forEach(function(tab) {
                tab.classList.toggle('active', tab.dataset.kind === saved.activeNavTab);
            });
        }

        // Restore edit mode
        if (saved.editEnabled) {
            toggleEditMode();
        }

        // Restore collapsed tree nodes
        if (saved.collapsedTreeNodes && Array.isArray(saved.collapsedTreeNodes)) {
            editState.collapsedTreeNodes = new Set(saved.collapsedTreeNodes);
        }

        // Restore open cards (fetch each)
        if (saved.openCardIds && saved.openCardIds.length > 0) {
            const collapsedSet = new Set(saved.collapsedCards || []);
            // Load cards in reverse so they end up in correct order
            const ids = saved.openCardIds.slice().reverse();
            (async function restoreCards() {
                for (const id of ids) {
                    const data = await apiFetch('/api/requirement/' + encodeURIComponent(id));
                    if (data && !data.error) {
                        editState.openCards.set(id, {
                            data: data,
                            collapsed: collapsedSet.has(id)
                        });
                        editState.openCardOrder.push(id);
                    }
                }
                // Reverse to restore original order (most recent first)
                editState.openCardOrder.reverse();
                renderCardStack();
                updateNavSelection();
                // Restore edit mode state on cards
                if (editState.enabled) {
                    document.querySelectorAll('.card-assertion-text').forEach(function(el) {
                        el.contentEditable = 'true';
                    });
                    document.querySelectorAll('.edit-only').forEach(function(el) {
                        el.style.display = '';
                    });
                }
            })();
        }
    }
});
</script>

</body>
</html>
